# Ops System 代码架构文档

## 项目概述

Ops System 是一个基于 Rust 的分布式运维监控系统，采用客户端-服务端架构。系统通过 TCP 长连接收集客户端系统信息和应用版本，并提供 Web 界面进行管理和控制。

## 项目结构

```
ops-system/
├── ops-client/          # 客户端模块
├── ops-server/          # 服务端模块  
├── ops-common/          # 共享代码库
└── Cargo.toml          # Workspace 配置
```

### 依赖关系
- ops-client 依赖 ops-common
- ops-server 依赖 ops-common
- 使用 Workspace 管理统一依赖版本

## 核心架构

### 1. 客户端架构 (ops-client)

#### 主要模块
- **tcp_services/client.rs** - TCP 连接管理和通信
- **collection/** - 系统信息收集模块
  - `system_info.rs` - 系统信息收集
  - `version_collector.rs` - 应用版本信息收集

#### 核心功能

**TcpSession 结构体** (`ops-client/src/tcp_services/client.rs:26`)
- 管理与服务端的 TCP 长连接
- 支持自动重连机制 (指数退避算法)
- 使用 Arc<Mutex<AsyncTcpStream>> 支持并发访问

**关键方法**：
- `new()` - 创建新的 TCP 会话
- `connect_with_retry()` - 带重试的连接建立
- `send_data()` - 发送数据到服务端
- `start_heartbeat()` - 启动心跳任务 (每3秒)
- `receive()` - 接收服务端消息
- `handle_command()` - 处理服务端命令

**工作流程**：
1. 启动时创建唯一客户端ID (存储在 `/tmp/client_id.txt`)
2. 建立与服务端的 TCP 连接 (硬编码地址: `10.1.1.18:12345`)
3. 启动心跳任务，定期发送系统信息
4. 监听服务端消息，支持命令执行

**数据收集**：
- 系统信息：CPU、内存、网络接口等
- 应用版本：扫描 `/tmp/apps/` 目录下的 `version.txt` 文件

### 2. 服务端架构 (ops-server)

#### 主要模块
- **tcp_services/handle_socket.rs** - TCP 连接处理
- **web/** - HTTP Web 服务
  - `routes.rs` - 路由定义
  - `handlers.rs` - 请求处理器
- **shared_data_handle.rs** - 共享数据管理

#### 核心功能

**双服务架构**：
- TCP 服务监听 `0.0.0.0:12345` - 接收客户端数据
- HTTP 服务监听 `0.0.0.0:3000` - 提供 Web 管理界面

**SharedDataHandle** (`ops-server/src/shared_data_handle.rs:8`)
- 使用 Arc<Mutex<SharedData>> 实现线程安全的共享状态
- 管理客户端信息和 TCP 连接映射

**TCP 消息处理** (`ops-server/src/tcp_services/handle_socket.rs`)
- 支持消息类型枚举：`ClientInfo` 和 `CommandResponse`
- 客户端连接管理和数据更新
- 自动清理过期连接 (5分钟超时)

**Web API 接口**：
- `GET /` - 返回管理界面 (index.html)
- `GET /api/clients` - 获取所有客户端信息
- `POST /api/send-message` - 广播消息到所有客户端  
- `POST /api/send-command` - 发送命令到指定客户端
- `GET /data` - 兼容旧接口

### 3. 共享代码库 (ops-common)

#### 核心数据结构

**HostInfo** (`ops-common/src/lib.rs:8`)
```rust
pub struct HostInfo {
    pub hostname: String,
    pub cpu_model: String,
    pub cpu_usage: f32,
    pub total_memory: u64,
    pub free_memory: u64,
    pub used_memory: u64,
    pub ip_addresses: Vec<String>,
}
```

**VersionInfo** (`ops-common/src/lib.rs:57`)
```rust
pub struct VersionInfo {
    pub app: String,
    pub created_time: String,
}
```

**ClientInfo** (`ops-common/src/lib.rs:63`)
```rust
pub struct ClientInfo {
    pub client_id: String,
    pub system_info: HostInfo,
    pub version_info: Vec<VersionInfo>,
    pub last_seen: SystemTime,
}
```

## 通信协议

### 1. 客户端到服务端
- **心跳数据**：定期发送 ClientInfo JSON 数据 (每3秒)
- **命令响应**：执行命令后返回结果

### 2. 服务端到客户端  
- **ACK确认**：接收数据后发送 "ACK"
- **命令下发**：格式为 "CMD:{command}ACK"
- **广播消息**：任意文本消息

### 3. 数据序列化
- 使用 serde_json 进行 JSON 序列化
- 支持消息类型标记 (`data_type` 字段)

## 主要特性

### 1. 高可用性
- 客户端自动重连机制
- 指数退避重试策略
- TCP Keepalive 支持

### 2. 并发处理
- 使用 Tokio 异步运行时
- Arc<Mutex<>> 实现线程安全
- 每个客户端连接独立处理

### 3. 数据管理
- 内存存储客户端状态
- 自动清理过期数据
- 实时连接状态跟踪

### 4. 命令执行
- 支持远程 Shell 命令执行
- 命令日志记录 (`/tmp/client_commands.log`)
- 输出结果回传

### 5. Web 管理
- 静态文件服务
- RESTful API 接口
- 实时客户端状态查看

## 部署说明

### 构建和运行
```bash
# 构建整个项目
cargo build --release

# 运行服务端
cargo run --bin ops-server

# 运行客户端  
cargo run --bin ops-client
```

### 访问方式
- Web 界面: http://localhost:3000
- API 接口: http://localhost:3000/api/*
- TCP 服务: tcp://localhost:12345

## 文件路径说明

### 客户端关键文件
- `/tmp/client_id.txt` - 客户端唯一ID存储
- `/tmp/apps/*/version.txt` - 应用版本信息文件
- `/tmp/client_commands.log` - 命令执行日志

### 服务端静态资源
- `ops-server/static/index.html` - Web 管理界面

## 技术栈

- **语言**: Rust (2024 Edition)
- **异步运行时**: Tokio
- **Web 框架**: Axum
- **序列化**: serde + serde_json  
- **系统信息**: sysinfo + hostname
- **网络**: socket2 + pnet_datalink

## 安全考虑

- 硬编码服务端地址，生产环境需要配置化
- 命令执行功能存在安全风险，需要权限控制
- TCP 连接未加密，敏感环境需要 TLS
- 无认证机制，需要增加身份验证

## 扩展建议

1. **配置管理**: 增加配置文件支持
2. **持久化存储**: 替换内存存储为数据库
3. **安全增强**: 添加 TLS 和认证机制
4. **监控告警**: 增加指标监控和告警功能
5. **日志系统**: 结构化日志和集中收集
6. **高可用**: 支持服务端集群部署