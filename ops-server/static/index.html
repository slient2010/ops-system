<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰¹æ˜“è¡ŒæœåŠ¡ç®¡ç†</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            padding: 15px; 
            background: #f5f5f5; 
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 10px;
        }
        h1 { color: #2c3e50; text-align: center; }
        h2 { color: #333; border-bottom: 2px solid #3498db; padding-bottom: 3px; }
        
        .section { 
            margin: 15px 0; 
            padding: 15px; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
        }
        
        .form-group { margin: 15px 0; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #555;
        }
        
        input, select, textarea, button { 
            padding: 12px; 
            margin: 5px 0; 
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        input[type="text"], select { 
            width: 100%; 
            max-width: 100%;
        }
        
        button { 
            background: #3498db; 
            color: white; 
            border: none; 
            cursor: pointer;
            min-width: 120px;
        }
        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        
        .client-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 15px; 
        }
        .client-card { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 6px; 
            border-left: 4px solid #27ae60;
        }
        .client-card h4 { margin: 0 0 10px 0; color: #2c3e50; }
        .client-info { font-size: 12px; color: #666; }
        
        .command-result { 
            background: #2c3e50; 
            color: #ecf0f1; 
            padding: 15px; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace; 
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status-indicator { 
            display: inline-block; 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            margin-right: 5px;
        }
        .status-online { background: #27ae60; }
        .status-offline { background: #e74c3c; }
        
        .loading { opacity: 0.6; }
        
        /* æ¶ˆæ¯æç¤ºåŒºåŸŸ - å³ä¸Šè§’å›ºå®šä½ç½® */
        #message-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
            width: auto;
        }
        
        .alert { 
            padding: 15px 20px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border-left: 4px solid #3498db;
            background: #ebf3fd;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.3s ease-out forwards;
            position: relative;
            padding-right: 45px;
            cursor: pointer;
        }
        
        .alert-success { 
            border-left-color: #27ae60; 
            background: #eafaf1; 
            color: #155724;
        }
        
        .alert-error { 
            border-left-color: #e74c3c; 
            background: #fdf2f2; 
            color: #721c24;
        }
        
        .alert-info {
            border-left-color: #3498db;
            background: #ebf3fd;
            color: #0c5460;
        }
        
        .alert:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        
        /* å…³é—­æŒ‰é’® */
        .alert::after {
            content: 'Ã—';
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            font-size: 20px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }
        
        .alert:hover::after {
            color: #666;
        }
        
        /* æ¶ˆæ¯æ»‘å…¥åŠ¨ç”» */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* æ¶ˆæ¯æ»‘å‡ºåŠ¨ç”» */
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        .alert.slide-out {
            animation: slideOut 0.3s ease-in forwards;
        }
        
        .command-history {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #fafafa;
        }
        .history-item {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #3498db;
            background: white;
            font-size: 12px;
        }

        /* åº”ç”¨ä¿¡æ¯æ ·å¼ */
        .app-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .client-apps {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .client-apps h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .app-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            margin: 8px 0;
        }

        .app-name {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .app-details {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .app-version {
            color: #28a745;
            font-weight: bold;
        }

        .no-apps {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            background: #ffffff;
            border: 1px solid #ddd;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
            border-radius: 6px 6px 0 0;
            color: #666;
        }

        .tab-button.active {
            background: #ffffff;
            border-bottom-color: #3498db;
            color: #3498db;
            font-weight: bold;
            border-color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-button:hover {
            background: #f0f8ff;
            color: #2980b9;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* åº”ç”¨ç®¡ç†è¡¨æ ¼æ ·å¼ */
        .app-management-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .app-management-table th,
        .app-management-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .app-management-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .app-management-table tr:hover {
            background: #f5f5f5;
        }

        /* å‘½ä»¤æ‰§è¡ŒåŒºåŸŸæ ·å¼ï¼ˆä¸åº”ç”¨ç®¡ç†ä¸€è‡´ï¼‰ */
        .command-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .command-form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .command-form-left,
        .command-form-right {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .command-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-top: 20px;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
            }
            
            .container {
                padding: 0 5px;
            }
            
            h1 {
                font-size: 24px;
                margin: 10px 0;
            }
            
            h2 {
                font-size: 18px;
                margin: 15px 0 10px 0;
            }
            
            .section {
                margin: 10px 0;
                padding: 12px;
            }
            
            .tabs {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .tab-button {
                flex: 1;
                min-width: 80px;
                padding: 8px 12px;
                font-size: 12px;
                margin-right: 0;
                margin-bottom: 5px;
            }
            
            .command-form-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .client-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .app-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            input, select, textarea, button {
                padding: 14px; /* æ›´å¤§çš„è§¦æ‘¸ç›®æ ‡ */
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
            }
            
            button {
                min-width: 100px;
                padding: 14px 20px;
            }
            
            .app-management-table {
                font-size: 12px;
            }
            
            .app-management-table th,
            .app-management-table td {
                padding: 8px 4px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            .action-btn {
                min-width: 80px;
                font-size: 11px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 15px;
            }
            
            .command-result {
                font-size: 12px;
                max-height: 200px;
            }
            
            .command-history {
                max-height: 150px;
            }
        }
        
        /* è¶…å°å±å¹•é€‚é… */
        @media (max-width: 480px) {
            .container {
                padding: 0;
            }
            
            .section {
                margin: 8px 0;
                padding: 10px;
                border-radius: 6px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .tabs {
                justify-content: center;
            }
            
            .tab-button {
                font-size: 11px;
                padding: 6px 8px;
            }
            
            .app-management-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .form-group {
                margin: 10px 0;
            }
            
            input, select, textarea {
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
            }
            
            /* ç§»åŠ¨ç«¯æ¶ˆæ¯æç¤ºè°ƒæ•´ */
            #message-area {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            .alert {
                padding: 12px 15px;
                padding-right: 40px;
                font-size: 14px;
            }
            
            .alert::after {
                font-size: 18px;
                right: 12px;
            }
        }
        
        /* ä¸­ç­‰å±å¹•é€‚é… (å¹³æ¿) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 95%;
            }
            
            .app-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
            
            .client-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
            
            .command-form-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        /* å¤§å±å¹•ä¼˜åŒ– */
        @media (min-width: 1025px) {
            .container {
                max-width: 1200px;
            }
        }

        /* ç™»å½•ç•Œé¢æ ·å¼ */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 400px;
            max-width: 90%;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: #2c3e50;
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .login-header p {
            color: #666;
            margin: 0;
            font-size: 14px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-form .form-group {
            margin: 0;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .login-form input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .login-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .login-btn:hover {
            background: #2980b9;
        }

        .login-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .login-error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
            margin-top: 15px;
            font-size: 14px;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .auth-status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #2c3e50;
            color: white;
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            font-size: 14px;
        }

        .auth-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        /* è°ƒæ•´é¡µé¢å†…å®¹ä½ç½®ï¼Œä¸ºçŠ¶æ€æ ç•™å‡ºç©ºé—´ */
        body.authenticated {
            padding-top: 40px;
        }

        .authenticated .container {
            margin-top: 0;
        }

        .service-status {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-running {
            background: #d4edda;
            color: #155724;
        }

        .status-stopped {
            background: #f8d7da;
            color: #721c24;
        }

        .status-unknown {
            background: #fff3cd;
            color: #856404;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            min-width: 60px;
        }

        .btn-update {
            background: #007bff;
            color: white;
        }

        .btn-start {
            background: #28a745;
            color: white;
        }

        .btn-stop {
            background: #dc3545;
            color: white;
        }

        .btn-update:hover { background: #0056b3; }
        .btn-start:hover { background: #1e7e34; }
        .btn-stop:hover { background: #bd2130; }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: none;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="login-container" class="login-container" style="display: none;">
        <div class="login-box">
            <div class="login-header">
                <h2>ğŸ” ç‰¹æ˜“è¡ŒæœåŠ¡ç®¡ç†</h2>
                <p>è¯·è¾“å…¥æ‚¨çš„ç™»å½•å‡­æ®</p>
            </div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" name="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" name="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" id="login-btn" class="login-btn">ç™»å½•</button>
                <div id="login-error" class="login-error" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- è®¤è¯çŠ¶æ€æ  -->
    <div id="auth-status-bar" class="auth-status-bar" style="display: none;">
        <div class="auth-user-info">
            <span>ğŸ‘¤ å·²ç™»å½•ç”¨æˆ·: <strong id="current-user">--</strong></span>
            <span>ğŸ• ç™»å½•æ—¶é—´: <span id="login-time">--</span></span>
        </div>
        <button class="logout-btn" onclick="handleLogout()">ç™»å‡º</button>
    </div>

    <!-- æ¶ˆæ¯æç¤ºåŒºåŸŸ -->
    <div id="message-area"></div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div id="main-content" class="container" style="display: none;">
        <h1>ç‰¹æ˜“è¡ŒæœåŠ¡ç®¡ç†</h1>
        
        <!-- ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ -->
        <div class="section">
            <h2>ç³»ç»ŸçŠ¶æ€</h2>
            <div style="display: flex; gap: 20px; align-items: center;">
                <div>åœ¨çº¿å®¢æˆ·ç«¯: <strong id="online-count">0</strong></div>
                <div>æœ€åæ›´æ–°: <span id="last-update">-</span></div>
                <div>
                    <span class="status-indicator status-online"></span>
                    æœåŠ¡å™¨è¿è¡Œä¸­
                </div>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('system-info-tab')">ç³»ç»Ÿä¿¡æ¯</button>
            <button class="tab-button" onclick="showTab('app-management-tab')">åº”ç”¨ç®¡ç†</button>
            <button class="tab-button" onclick="showTab('command-tab')">å‘½ä»¤æ‰§è¡Œ</button>
	    <!--
            <button class="tab-button" onclick="showTab('broadcast-tab')">å¹¿æ’­æ¶ˆæ¯</button>
	    -->
        </div>

        <!-- ç³»ç»Ÿä¿¡æ¯æ ‡ç­¾é¡µ -->
        <div id="system-info-tab" class="section tab-content active">
            <!-- åº”ç”¨éƒ¨ç½²ä¿¡æ¯ -->
            <div style="margin-bottom: 30px;">
                <h2>åº”ç”¨éƒ¨ç½²ä¿¡æ¯</h2>
                <div style="margin-bottom: 10px;">
                    <button onclick="refreshAppsInfo()" style="padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">åˆ·æ–°åº”ç”¨ä¿¡æ¯</button>
                    <span id="apps-last-update" style="margin-left: 15px; color: #666; font-size: 12px;"></span>
                </div>
                <div id="apps-container">
                    <p>æ­£åœ¨åŠ è½½åº”ç”¨ä¿¡æ¯...</p>
                </div>
            </div>

            <!-- å®¢æˆ·ç«¯åˆ—è¡¨ -->
            <div>
                <h2>å®¢æˆ·ç«¯åˆ—è¡¨</h2>
                <div id="clients" class="client-grid"></div>
            </div>
        </div>

        <!-- å‘½ä»¤æ‰§è¡ŒåŒºåŸŸ -->
        <div id="command-tab" class="section tab-content">
            <h2>å‘½ä»¤æ‰§è¡Œ</h2>
            
            <div class="command-section">
                <div class="command-form-container">
                    <div class="command-form-left">
                        <div class="form-group">
                            <label for="client-select">é€‰æ‹©å®¢æˆ·ç«¯:</label>
                            <select id="client-select">
                                <option value="">-- é€‰æ‹©å®¢æˆ·ç«¯ --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>å‘½ä»¤ç±»å‹:</label>
                            <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 20px;">
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <input type="radio" id="predefined-cmd" name="command-type" value="predefined" checked onchange="toggleCommandType()">
                                    <label for="predefined-cmd" style="margin: 0;">é¢„å®šä¹‰å‘½ä»¤</label>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <input type="radio" id="custom-cmd" name="command-type" value="custom" onchange="toggleCommandType()">
                                    <label for="custom-cmd" style="margin: 0;">è‡ªå®šä¹‰å‘½ä»¤</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="command-form-right">
                        <!-- é¢„å®šä¹‰å‘½ä»¤é€‰æ‹© -->
                        <div id="predefined-commands-section" class="form-group">
                            <label for="predefined-select">é€‰æ‹©é¢„å®šä¹‰å‘½ä»¤:</label>
                            <select id="predefined-select" onchange="updateCommandDescription()">
                                <option value="">-- é€‰æ‹©é¢„å®šä¹‰å‘½ä»¤ --</option>
                            </select>
                            <div id="command-description" style="margin-top: 5px; font-size: 12px; color: #666; display: none;"></div>
                            
			    <!--
                            <div style="margin-top: 10px;">
                                <label for="category-filter">æŒ‰ç±»åˆ«ç­›é€‰:</label>
                                <select id="category-filter" onchange="filterCommandsByCategory()">
                                    <option value="">æ‰€æœ‰ç±»åˆ«</option>
                                </select>
                            </div>
			    -->
                        </div>
                        
                        <!-- è‡ªå®šä¹‰å‘½ä»¤è¾“å…¥ -->
                        <div id="custom-command-section" class="form-group" style="display: none;">
                            <label for="command-input">è‡ªå®šä¹‰å‘½ä»¤:</label>
                            <input type="text" id="command-input" placeholder="è¾“å…¥è¦æ‰§è¡Œçš„å‘½ä»¤ (å¦‚: ps aux, ls -la)" 
                                   onkeypress="handleCommandKeyPress(event)">
                            <div style="margin-top: 5px; font-size: 12px; color: #e74c3c;">
                                âš ï¸ è‡ªå®šä¹‰å‘½ä»¤å°†è¿›è¡Œå®‰å…¨éªŒè¯ï¼Œå±é™©å‘½ä»¤å°†è¢«æ‹’ç»æ‰§è¡Œ
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="command-controls">
                    <button id="execute-btn" onclick="executeCommand()" style="padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; min-width: 120px;">æ‰§è¡Œå‘½ä»¤</button>
                    <button onclick="clearResult()" style="padding: 8px 15px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">æ¸…ç©ºç»“æœ</button>
                </div>
            </div>
            
            <!-- å‘½ä»¤æ‰§è¡Œç»“æœ -->
            <div id="command-result-section" style="display: none;">
                <h3>æ‰§è¡Œç»“æœ:</h3>
                <div id="command-result" class="command-result">ç­‰å¾…å‘½ä»¤æ‰§è¡Œ...</div>
            </div>
            
            <!-- å‘½ä»¤å†å² -->
            <div>
                <h3>å‘½ä»¤å†å²:</h3>
                <div id="command-history" class="command-history">
                    <div class="history-item">æš‚æ— å†å²è®°å½•</div>
                </div>
            </div>
        </div>


        <!-- åº”ç”¨ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="app-management-tab" class="section tab-content">
            <!-- åº”ç”¨ç®¡ç† -->
            <div style="margin-bottom: 30px;">
                <h2>åº”ç”¨ç®¡ç†</h2>
                <div style="margin-bottom: 10px;">
                    <button onclick="refreshAppsManagement()" style="padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">åˆ·æ–°æ•°æ®</button>
                    <span id="app-management-last-update" style="margin-left: 15px; color: #666; font-size: 12px;"></span>
                </div>
                
                <!-- è¿‡æ»¤å™¨åŒºåŸŸ -->
                <div class="filter-section" style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;">ç­›é€‰æ¡ä»¶</h3>
                    <div class="filter-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label for="filter-client">å®¢æˆ·ç«¯:</label>
                            <select id="filter-client" onchange="applyFilters()">
                                <option value="">å…¨éƒ¨å®¢æˆ·ç«¯</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filter-app-name">åº”ç”¨åç§°:</label>
                            <input type="text" id="filter-app-name" placeholder="è¾“å…¥åº”ç”¨åç§°" oninput="applyFilters()">
                        </div>
                        <div class="form-group">
                            <label for="filter-status">çŠ¶æ€:</label>
                            <select id="filter-status" onchange="applyFilters()">
                                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="online">åœ¨çº¿</option>
                                <option value="offline">ç¦»çº¿</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filter-service-status">æœåŠ¡çŠ¶æ€:</label>
                            <select id="filter-service-status" onchange="applyFilters()">
                                <option value="">å…¨éƒ¨æœåŠ¡çŠ¶æ€</option>
                                <option value="running">è¿è¡Œä¸­</option>
                                <option value="stopped">å·²åœæ­¢</option>
                                <option value="unknown">æœªçŸ¥</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="clearFilters()" style="padding: 5px 15px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">æ¸…ç©ºç­›é€‰</button>
                        <span id="filter-results-info" style="margin-left: 15px; color: #666; font-size: 14px;"></span>
                    </div>
                </div>
                
                <div id="app-management-container">
                    <p>æ­£åœ¨åŠ è½½åº”ç”¨ç®¡ç†æ•°æ®...</p>
                </div>
            </div>
        </div>

        <!-- å¹¿æ’­æ¶ˆæ¯æ ‡ç­¾é¡µ -->
	<!--
        <div id="broadcast-tab" class="section tab-content">
            <div style="margin-bottom: 30px;">
                <h2>å¹¿æ’­æ¶ˆæ¯</h2>
                <div class="form-group">
                    <label for="broadcast-message">æ¶ˆæ¯å†…å®¹:</label>
                    <input type="text" id="broadcast-message" placeholder="è¾“å…¥è¦å¹¿æ’­ç»™æ‰€æœ‰å®¢æˆ·ç«¯çš„æ¶ˆæ¯">
                </div>
                <div class="form-group">
                    <button onclick="sendBroadcast()">å‘é€å¹¿æ’­</button>
                </div>
            </div>
        </div>
	-->
        
        </div>

        <!-- æ›´æ–°åº”ç”¨æ¨¡æ€æ¡† -->
        <div id="update-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>æ›´æ–°åº”ç”¨</h3>
                    <span class="close" onclick="closeModal('update-modal')">&times;</span>
                </div>
                <div class="form-group">
                    <label>å®¢æˆ·ç«¯:</label>
                    <div id="update-client-info"></div>
                </div>
                <div class="form-group">
                    <label>åº”ç”¨åç§°:</label>
                    <div id="update-app-info"></div>
                </div>
                <div class="form-group">
                    <label for="update-version">æ–°ç‰ˆæœ¬:</label>
                    <input type="text" id="update-version" placeholder="è¾“å…¥æ–°ç‰ˆæœ¬å· (å¦‚: v1.2.0)">
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button onclick="closeModal('update-modal')" style="margin-right: 10px; background: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                    <button onclick="confirmUpdate()" style="background: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">ç¡®è®¤æ›´æ–°</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let commandHistory = [];
        let pendingCommands = new Map(); // è·Ÿè¸ªå¾…æ‰§è¡Œçš„å‘½ä»¤
        let predefinedCommands = []; // å­˜å‚¨é¢„å®šä¹‰å‘½ä»¤
        let allPredefinedCommands = []; // å­˜å‚¨æ‰€æœ‰é¢„å®šä¹‰å‘½ä»¤ï¼ˆç”¨äºç­›é€‰ï¼‰
        let isAuthenticated = false; // è®¤è¯çŠ¶æ€
        let currentUser = null; // å½“å‰ç”¨æˆ·
        let loginTime = null; // ç™»å½•æ—¶é—´
        let lastActivity = null; // æœ€åæ´»åŠ¨æ—¶é—´
        let sessionTimeoutId = null; // ä¼šè¯è¶…æ—¶å®šæ—¶å™¨
        let activityCheckInterval = null; // æ´»åŠ¨æ£€æŸ¥å®šæ—¶å™¨
        const SESSION_TIMEOUT = 60 * 60 * 1000; // 1å°æ—¶ (60 * 60 * 1000ms)
        const ACTIVITY_CHECK_INTERVAL = 60 * 1000; // æ¯1åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ (60 * 1000ms)
        const WARNING_TIME = 5 * 60 * 1000; // æå‰5åˆ†é’Ÿè­¦å‘Š (5 * 60 * 1000ms)

        // è®¤è¯ç›¸å…³å‡½æ•°
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/check-auth', {
                    credentials: 'include' // åŒ…å« cookies
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        setAuthenticatedState(result.session_id);
                        return true;
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
            }
            
            setUnauthenticatedState();
            return false;
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('login-btn');
            const errorDiv = document.getElementById('login-error');
            
            // ç¦ç”¨ç™»å½•æŒ‰é’®
            loginBtn.disabled = true;
            loginBtn.textContent = 'ç™»å½•ä¸­...';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    setAuthenticatedState(result.session_id, username);
                    showMessage('ç™»å½•æˆåŠŸï¼Œæ¬¢è¿ä½¿ç”¨ç‰¹æ˜“è¡ŒæœåŠ¡ç®¡ç†ç³»ç»Ÿï¼', 'success');
                } else {
                    errorDiv.textContent = result.message;
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                errorDiv.style.display = 'block';
                console.error('ç™»å½•é”™è¯¯:', error);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'ç™»å½•';
            }
        }

        async function handleLogout() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                return;
            }
            
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('ç™»å‡ºè¯·æ±‚å¤±è´¥:', error);
            }
            
            setUnauthenticatedState();
            showMessage('å·²æˆåŠŸé€€å‡ºç™»å½•', 'info');
        }

        function setAuthenticatedState(sessionId, username = 'admin') {
            isAuthenticated = true;
            currentUser = username;
            loginTime = new Date();
            lastActivity = new Date();
            
            // æ›´æ–°UI
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('auth-status-bar').style.display = 'flex';
            document.getElementById('main-content').style.display = 'block';
            document.body.classList.add('authenticated');
            
            // æ›´æ–°çŠ¶æ€æ ä¿¡æ¯
            document.getElementById('current-user').textContent = currentUser;
            document.getElementById('login-time').textContent = loginTime.toLocaleString('zh-CN');
            
            // å¯åŠ¨æ´»åŠ¨ç›‘æ§
            startActivityMonitoring();
            
            // åˆå§‹åŒ–ä¸»è¦åŠŸèƒ½
            initializeApp();
        }

        function setUnauthenticatedState() {
            isAuthenticated = false;
            currentUser = null;
            loginTime = null;
            lastActivity = null;
            
            // åœæ­¢æ´»åŠ¨ç›‘æ§
            stopActivityMonitoring();
            
            // æ›´æ–°UI
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('auth-status-bar').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
            document.body.classList.remove('authenticated');
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-error').style.display = 'none';
        }

        function initializeApp() {
            fetchClients();
            fetchPredefinedCommands();
            fetchAppsInfo();
            // å®šæœŸåˆ·æ–°å®¢æˆ·ç«¯åˆ—è¡¨å’Œåº”ç”¨ä¿¡æ¯
            setInterval(fetchClients, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡å®¢æˆ·ç«¯çŠ¶æ€
            setInterval(fetchAppsInfo, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡åº”ç”¨ä¿¡æ¯
            // å¦‚æœåœ¨åº”ç”¨ç®¡ç†æ ‡ç­¾é¡µï¼Œä¹Ÿå®šæœŸåˆ·æ–°
            setInterval(() => {
                if (document.getElementById('app-management-tab').classList.contains('active')) {
                    refreshAppsManagement();
                }
            }, 15000); // 15ç§’åˆ·æ–°ä¸€æ¬¡åº”ç”¨ç®¡ç†æ•°æ®
        }
        
        // è·å–å®¢æˆ·ç«¯åˆ—è¡¨
        async function fetchClients() {
            if (!isAuthenticated) {
                return;
            }
            
            try {
                const response = await fetch('/api/clients', {
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    // è®¤è¯å¤±æ•ˆï¼Œé‡æ–°æ˜¾ç¤ºç™»å½•ç•Œé¢
                    handleAutoLogout('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    return;
                }
                
                const data = await response.json();
                
                updateClientsList(data.clients);
                updateClientSelect(data.clients);
                updateSystemStatus(data.clients);
                
            } catch (error) {
                showMessage('è·å–å®¢æˆ·ç«¯åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ›´æ–°å®¢æˆ·ç«¯åˆ—è¡¨æ˜¾ç¤º
        function updateClientsList(clients) {
            const clientsContainer = document.getElementById('clients');
            clientsContainer.innerHTML = '';
            
            if (Object.keys(clients).length === 0) {
                clientsContainer.innerHTML = '<div class="client-card">æš‚æ— åœ¨çº¿å®¢æˆ·ç«¯</div>';
                return;
            }
            
            Object.entries(clients).forEach(([id, client]) => {
                const clientCard = document.createElement('div');
                clientCard.className = 'client-card';
                
                // è·å–å®¢æˆ·ç«¯çŠ¶æ€
                const clientStatus = getClientStatus(client.last_seen);
                const statusClass = clientStatus.status === 'online' ? 'status-online' : 'status-offline';
                const statusText = clientStatus.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿';
                
                // å¦‚æœç¦»çº¿ï¼Œç»™å¡ç‰‡æ·»åŠ ç‰¹æ®Šæ ·å¼
                if (clientStatus.status === 'offline') {
                    clientCard.style.opacity = '0.6';
                    clientCard.style.borderLeftColor = '#e74c3c';
                }
                
                clientCard.innerHTML = `
                    <h4>
                        <span class="status-indicator ${statusClass}"></span>
                        ${client.system_info.hostname} 
                        <small style="color: ${clientStatus.status === 'online' ? '#27ae60' : '#e74c3c'};">(${statusText})</small>
                    </h4>
                    <div class="client-info">
                        <div><strong>å®¢æˆ·ç«¯ID:</strong> ${id.substring(0, 8)}...</div>
                        <div><strong>CPU:</strong> ${client.system_info.cpu_model}</div>
                        <div><strong>å†…å­˜:</strong> ${formatBytes(client.system_info.used_memory)} / ${formatBytes(client.system_info.total_memory)}</div>
                        <div><strong>IPåœ°å€:</strong> ${client.system_info.ip_addresses.join(', ')}</div>
                        <div><strong>æœ€åå¿ƒè·³:</strong> ${formatTime(client.last_seen)} (${clientStatus.timeAgo})</div>
                        ${clientStatus.diffSeconds > 30 ? '<div style="color: #e74c3c; font-size: 12px;"><strong>âš ï¸ å®¢æˆ·ç«¯å¯èƒ½å·²æ–­å¼€è¿æ¥</strong></div>' : ''}
                    </div>
                `;
                clientsContainer.appendChild(clientCard);
            });
        }
        
        // æ›´æ–°å®¢æˆ·ç«¯é€‰æ‹©ä¸‹æ‹‰æ¡†
        function updateClientSelect(clients) {
            const clientSelect = document.getElementById('client-select');
            const currentValue = clientSelect.value;
            
            // ä¿ç•™ç¬¬ä¸€ä¸ªé»˜è®¤é€‰é¡¹
            clientSelect.innerHTML = '<option value="">-- é€‰æ‹©å®¢æˆ·ç«¯ --</option>';
            
            Object.entries(clients).forEach(([id, client]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${client.system_info.hostname} (${id.substring(0, 8)})`;
                clientSelect.appendChild(option);
            });
            
            // æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼
            if (currentValue) {
                clientSelect.value = currentValue;
            }
        }
        
        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus(clients) {
            document.getElementById('online-count').textContent = Object.keys(clients).length;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }
        
        // æ‰§è¡Œå‘½ä»¤
        async function executeCommand() {
            const clientId = document.getElementById('client-select').value;
            let command;
            
            if (!clientId) {
                showMessage('è¯·é€‰æ‹©è¦æ‰§è¡Œå‘½ä»¤çš„å®¢æˆ·ç«¯', 'error');
                return;
            }
            
            try {
                command = getSelectedCommand();
            } catch (error) {
                showMessage(error.message, 'error');
                return;
            }
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            addToHistory(clientId, command);
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸå’ŒåŠ è½½çŠ¶æ€
            showCommandResult();
            document.getElementById('command-result').textContent = 'æ­£åœ¨å‘é€å‘½ä»¤åˆ°å®¢æˆ·ç«¯...';
            
            // ç¦ç”¨æŒ‰é’®
            const btn = document.getElementById('execute-btn');
            btn.disabled = true;
            btn.textContent = 'æ‰§è¡Œä¸­...';
            
            try {
                const response = await fetch('/api/send-command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ client_id: clientId, command })
                });
                
                if (response.status === 401) {
                    handleAutoLogout('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    return;
                }
                
                if (response.ok) {
                    const result = await response.json();
                    const commandId = result.command_id;
                    
                    showMessage('å‘½ä»¤å‘é€æˆåŠŸï¼Œç­‰å¾…æ‰§è¡Œç»“æœ...', 'success');
                    document.getElementById('command-result').textContent = `å‘½ä»¤å·²å‘é€ï¼Œæ­£åœ¨ç­‰å¾…å®¢æˆ·ç«¯æ‰§è¡Œ...\nå‘½ä»¤ID: ${commandId}`;
                    
                    // å¼€å§‹è½®è¯¢å‘½ä»¤ç»“æœ
                    pollCommandResult(commandId);
                    
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
                
            } catch (error) {
                showMessage('å‘½ä»¤å‘é€å¤±è´¥: ' + error.message, 'error');
                document.getElementById('command-result').textContent = 'å‘½ä»¤å‘é€å¤±è´¥: ' + error.message;
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.disabled = false;
                btn.textContent = 'æ‰§è¡Œå‘½ä»¤';
            }
        }
        
        // è½®è¯¢å‘½ä»¤æ‰§è¡Œç»“æœ
        async function pollCommandResult(commandId, maxAttempts = 20) {
            let attempts = 0;
            const pollInterval = 1000; // 1ç§’è½®è¯¢ä¸€æ¬¡
            
            const poll = async () => {
                attempts++;
                
                try {
                    const response = await fetch(`/api/command-result?command_id=${commandId}`);
                    
                    if (response.ok) {
                        const status = await response.json();
                        
                        if (status.Completed) {
                            // å‘½ä»¤æ‰§è¡Œå®Œæˆ
                            const result = status.Completed;
                            displayCommandResult(result);
                            
                            // æ¢å¤æŒ‰é’®çŠ¶æ€
                            const btn = document.getElementById('execute-btn');
                            btn.disabled = false;
                            btn.textContent = 'æ‰§è¡Œå‘½ä»¤';
                            
                            showMessage('å‘½ä»¤æ‰§è¡Œå®Œæˆ', 'success');
                            return;
                        } else if (status.Failed) {
                            // å‘½ä»¤æ‰§è¡Œå¤±è´¥
                            document.getElementById('command-result').textContent = 
                                `å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${status.Failed}`;
                            
                            // æ¢å¤æŒ‰é’®çŠ¶æ€
                            const btn = document.getElementById('execute-btn');
                            btn.disabled = false;
                            btn.textContent = 'æ‰§è¡Œå‘½ä»¤';
                            
                            showMessage('å‘½ä»¤æ‰§è¡Œå¤±è´¥', 'error');
                            return;
                        } else if (status.Timeout) {
                            // å‘½ä»¤è¶…æ—¶
                            document.getElementById('command-result').textContent = 'å‘½ä»¤æ‰§è¡Œè¶…æ—¶';
                            
                            // æ¢å¤æŒ‰é’®çŠ¶æ€
                            const btn = document.getElementById('execute-btn');
                            btn.disabled = false;
                            btn.textContent = 'æ‰§è¡Œå‘½ä»¤';
                            
                            showMessage('å‘½ä»¤æ‰§è¡Œè¶…æ—¶', 'error');
                            return;
                        }
                        
                        // ç»§ç»­è½®è¯¢
                        if (attempts < maxAttempts) {
                            document.getElementById('command-result').textContent = 
                                `æ­£åœ¨ç­‰å¾…æ‰§è¡Œç»“æœ... (${attempts}/${maxAttempts})`;
                            setTimeout(poll, pollInterval);
                        } else {
                            // è¶…è¿‡æœ€å¤§å°è¯•æ¬¡æ•°
                            document.getElementById('command-result').textContent = 
                                'ç­‰å¾…æ‰§è¡Œç»“æœè¶…æ—¶ï¼Œè¯·æ£€æŸ¥å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€';
                            
                            // æ¢å¤æŒ‰é’®çŠ¶æ€
                            const btn = document.getElementById('execute-btn');
                            btn.disabled = false;
                            btn.textContent = 'æ‰§è¡Œå‘½ä»¤';
                            
                            showMessage('ç­‰å¾…æ‰§è¡Œç»“æœè¶…æ—¶', 'error');
                        }
                        
                    } else {
                        throw new Error(`Failed to get command status: ${response.status}`);
                    }
                    
                } catch (error) {
                    console.error('Error polling command result:', error);
                    
                    // ç»§ç»­å°è¯•ï¼Œä½†å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯å°±æå‰ç»“æŸ
                    if (attempts < maxAttempts && !error.message.includes('fetch')) {
                        setTimeout(poll, pollInterval);
                    } else {
                        document.getElementById('command-result').textContent = 
                            `è·å–å‘½ä»¤ç»“æœæ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`;
                        
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        const btn = document.getElementById('execute-btn');
                        btn.disabled = false;
                        btn.textContent = 'æ‰§è¡Œå‘½ä»¤';
                        
                        showMessage('è·å–å‘½ä»¤ç»“æœå¤±è´¥', 'error');
                    }
                }
            };
            
            // å¼€å§‹è½®è¯¢
            setTimeout(poll, pollInterval);
        }
        
        // æ˜¾ç¤ºå‘½ä»¤æ‰§è¡Œç»“æœ
        function displayCommandResult(result) {
            const resultElement = document.getElementById('command-result');
            
            let displayText = `å‘½ä»¤: ${result.command}\n`;
            displayText += `æ‰§è¡Œæ—¶é—´: ${formatTime(result.executed_at)}\n`;
            displayText += `é€€å‡ºç : ${result.exit_code}\n`;
            displayText += `\n--- æ ‡å‡†è¾“å‡º ---\n${result.output || '(æ— è¾“å‡º)'}`;
            
            if (result.error_output && result.error_output.trim()) {
                displayText += `\n\n--- é”™è¯¯è¾“å‡º ---\n${result.error_output}`;
            }
            
            resultElement.textContent = displayText;
        }
        
        // å¤„ç†å›è½¦é”®æ‰§è¡Œå‘½ä»¤
        function handleCommandKeyPress(event) {
            if (event.key === 'Enter') {
                executeCommand();
            }
        }
        
        // æ˜¾ç¤ºå‘½ä»¤ç»“æœåŒºåŸŸ
        function showCommandResult() {
            document.getElementById('command-result-section').style.display = 'block';
        }
        
        // æ¸…ç©ºç»“æœ
        function clearResult() {
            document.getElementById('command-result').textContent = '';
            document.getElementById('command-result-section').style.display = 'none';
        }
        
        // æ·»åŠ åˆ°å‘½ä»¤å†å²
        function addToHistory(clientId, command) {
            const historyContainer = document.getElementById('command-history');
            
            // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå‘½ä»¤ï¼Œæ¸…ç©ºé»˜è®¤æ–‡æœ¬
            if (historyContainer.textContent.includes('æš‚æ— å†å²è®°å½•')) {
                historyContainer.innerHTML = '';
            }
            
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <div><strong>[${new Date().toLocaleTimeString()}]</strong> ${command}</div>
                <div>ç›®æ ‡: ${clientId.substring(0, 8)}... <button onclick="repeatCommand('${clientId}', '${command}')" style="font-size: 10px; padding: 2px 5px;">é‡å¤æ‰§è¡Œ</button></div>
            `;
            
            historyContainer.insertBefore(historyItem, historyContainer.firstChild);
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            while (historyContainer.children.length > 10) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
        }
        
        // é‡å¤æ‰§è¡Œå‘½ä»¤
        function repeatCommand(clientId, command) {
            document.getElementById('client-select').value = clientId;
            document.getElementById('command-input').value = command;
            executeCommand();
        }
        
        // å‘é€å¹¿æ’­æ¶ˆæ¯
        async function sendBroadcast() {
            const message = document.getElementById('broadcast-message').value.trim();
            if (!message) {
                showMessage('è¯·è¾“å…¥å¹¿æ’­æ¶ˆæ¯å†…å®¹', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/send-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                if (response.ok) {
                    showMessage('å¹¿æ’­æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
                    document.getElementById('broadcast-message').value = '';
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                showMessage('å¹¿æ’­æ¶ˆæ¯å‘é€å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type}`;
            messageDiv.textContent = message;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»å¯å…³é—­
            messageDiv.addEventListener('click', function() {
                closeMessage(messageDiv);
            });
            
            messageArea.appendChild(messageDiv);
            
            // 8ç§’åè‡ªåŠ¨åˆ é™¤æ¶ˆæ¯ (æ¯”åŸæ¥é•¿ä¸€ç‚¹ï¼Œç»™ç”¨æˆ·æ›´å¤šæ—¶é—´é˜…è¯»)
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    closeMessage(messageDiv);
                }
            }, 8000);
        }
        
        // å…³é—­æ¶ˆæ¯çš„å‡½æ•°ï¼Œå¸¦æœ‰æ»‘å‡ºåŠ¨ç”»
        function closeMessage(messageDiv) {
            if (!messageDiv.parentNode) return;
            
            messageDiv.classList.add('slide-out');
            
            // ç­‰å¾…åŠ¨ç”»å®Œæˆååˆ é™¤å…ƒç´ 
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 300); // ä¸CSSåŠ¨ç”»æ—¶é•¿åŒ¹é…
        }
        
        // æ ¼å¼åŒ–å­—èŠ‚æ•°
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            if (!timestamp) return 'æœªçŸ¥';
            
            // å¤„ç† {secs_since_epoch, nanos_since_epoch} æ ¼å¼
            if (typeof timestamp === 'object' && timestamp.secs_since_epoch) {
                const date = new Date(timestamp.secs_since_epoch * 1000);
                return date.toLocaleString('zh-CN');
            }
            
            // å¤„ç†å…¶ä»–æ ¼å¼
            const date = new Date(timestamp);
            if (isNaN(date.getTime())) {
                return 'æ— æ•ˆæ—¶é—´';
            }
            return date.toLocaleString('zh-CN');
        }
        
        // è®¡ç®—å®¢æˆ·ç«¯çŠ¶æ€å’Œæœ€åå¿ƒè·³æ—¶é—´å·®
        function getClientStatus(lastSeen) {
            if (!lastSeen) return { status: 'offline', timeAgo: 'æœªçŸ¥' };
            
            let lastSeenTime;
            if (typeof lastSeen === 'object' && lastSeen.secs_since_epoch) {
                lastSeenTime = new Date(lastSeen.secs_since_epoch * 1000);
            } else {
                lastSeenTime = new Date(lastSeen);
            }
            
            const now = new Date();
            const diffSeconds = Math.floor((now - lastSeenTime) / 1000);
            
            let timeAgo;
            if (diffSeconds < 60) {
                timeAgo = diffSeconds + 'ç§’å‰';
            } else if (diffSeconds < 3600) {
                timeAgo = Math.floor(diffSeconds / 60) + 'åˆ†é’Ÿå‰';
            } else {
                timeAgo = Math.floor(diffSeconds / 3600) + 'å°æ—¶å‰';
            }
            
            // 30ç§’å†…è®¤ä¸ºåœ¨çº¿ï¼Œè¶…è¿‡30ç§’è®¤ä¸ºç¦»çº¿
            const status = diffSeconds <= 30 ? 'online' : 'offline';
            
            return { status, timeAgo, diffSeconds };
        }
        
        // åˆ‡æ¢å‘½ä»¤ç±»å‹ï¼ˆé¢„å®šä¹‰ vs è‡ªå®šä¹‰ï¼‰
        function toggleCommandType() {
            const predefinedRadio = document.getElementById('predefined-cmd');
            const predefinedSection = document.getElementById('predefined-commands-section');
            const customSection = document.getElementById('custom-command-section');
            
            if (predefinedRadio.checked) {
                predefinedSection.style.display = 'block';
                customSection.style.display = 'none';
            } else {
                predefinedSection.style.display = 'none';
                customSection.style.display = 'block';
            }
        }
        
        // è·å–é¢„å®šä¹‰å‘½ä»¤åˆ—è¡¨
        async function fetchPredefinedCommands() {
            try {
                const response = await fetch('/api/predefined-commands');
                if (response.ok) {
                    allPredefinedCommands = await response.json();
                    predefinedCommands = [...allPredefinedCommands];
                    updatePredefinedCommandsUI();
                } else {
                    // å¦‚æœæœåŠ¡ç«¯æ²¡æœ‰æä¾›APIï¼Œä½¿ç”¨æœ¬åœ°é»˜è®¤å‘½ä»¤
                    allPredefinedCommands = getDefaultPredefinedCommands();
                    predefinedCommands = [...allPredefinedCommands];
                    updatePredefinedCommandsUI();
                }
            } catch (error) {
                // ä½¿ç”¨æœ¬åœ°é»˜è®¤å‘½ä»¤ä½œä¸ºå¤‡é€‰
                allPredefinedCommands = getDefaultPredefinedCommands();
                predefinedCommands = [...allPredefinedCommands];
                updatePredefinedCommandsUI();
            }
        }
        
        // è·å–é»˜è®¤çš„é¢„å®šä¹‰å‘½ä»¤ï¼ˆå¦‚æœæœåŠ¡ç«¯APIä¸å¯ç”¨ï¼‰
        function getDefaultPredefinedCommands() {
            return [
                { command: "ps aux", name: "æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹", category: "ç³»ç»Ÿä¿¡æ¯", description: "æ˜¾ç¤ºæ‰€æœ‰è¿è¡Œä¸­çš„è¿›ç¨‹è¯¦ç»†ä¿¡æ¯" },
                { command: "whoami", name: "æŸ¥çœ‹å½“å‰ç”¨æˆ·", category: "ç³»ç»Ÿä¿¡æ¯", description: "æ˜¾ç¤ºå½“å‰ç™»å½•çš„ç”¨æˆ·å" },
                { command: "free -h", name: "æŸ¥çœ‹å†…å­˜ä½¿ç”¨", category: "èµ„æºç›‘æ§", description: "ä»¥äººç±»å¯è¯»æ ¼å¼æ˜¾ç¤ºå†…å­˜ä½¿ç”¨æƒ…å†µ" },
                { command: "df -h", name: "æŸ¥çœ‹ç£ç›˜ç©ºé—´", category: "èµ„æºç›‘æ§", description: "ä»¥äººç±»å¯è¯»æ ¼å¼æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ" },
                { command: "top -n 1", name: "æŸ¥çœ‹è¿›ç¨‹èµ„æºä½¿ç”¨", category: "èµ„æºç›‘æ§", description: "æ˜¾ç¤ºå½“å‰è¿›ç¨‹CPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µ" },
                { command: "netstat -tlnp", name: "æŸ¥çœ‹ç›‘å¬ç«¯å£", category: "ç½‘ç»œä¿¡æ¯", description: "æ˜¾ç¤ºæ‰€æœ‰TCPç›‘å¬ç«¯å£" },
                { command: "ls -la", name: "æŸ¥çœ‹ç›®å½•å†…å®¹", category: "æ–‡ä»¶ç³»ç»Ÿ", description: "è¯¦ç»†æ˜¾ç¤ºå½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹" },
                { command: "systemctl status", name: "æŸ¥çœ‹æœåŠ¡çŠ¶æ€", category: "æœåŠ¡ç®¡ç†", description: "æ˜¾ç¤ºç³»ç»ŸæœåŠ¡çš„æ€»ä½“çŠ¶æ€" },
                { command: "date", name: "æŸ¥çœ‹ç³»ç»Ÿæ—¶é—´", category: "ç³»ç»Ÿä¿¡æ¯", description: "æ˜¾ç¤ºå½“å‰ç³»ç»Ÿæ—¥æœŸå’Œæ—¶é—´" },
                { command: "uptime", name: "æŸ¥çœ‹ç³»ç»Ÿè¿è¡Œæ—¶é—´", category: "ç³»ç»Ÿä¿¡æ¯", description: "æ˜¾ç¤ºç³»ç»Ÿè¿è¡Œæ—¶é—´å’Œè´Ÿè½½" }
            ];
        }
        
        // æ›´æ–°é¢„å®šä¹‰å‘½ä»¤UI
        function updatePredefinedCommandsUI() {
            // æ›´æ–°å‘½ä»¤é€‰æ‹©ä¸‹æ‹‰æ¡†
            const select = document.getElementById('predefined-select');
            select.innerHTML = '<option value="">-- é€‰æ‹©é¢„å®šä¹‰å‘½ä»¤ --</option>';
            
            predefinedCommands.forEach((cmd, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `[${cmd.category}] ${cmd.name}`;
                select.appendChild(option);
            });
            
            // æ›´æ–°ç±»åˆ«ç­›é€‰ä¸‹æ‹‰æ¡†
            const categories = [...new Set(allPredefinedCommands.map(cmd => cmd.category))];
            const categorySelect = document.getElementById('category-filter');
            categorySelect.innerHTML = '<option value="">æ‰€æœ‰ç±»åˆ«</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }
        
        // æŒ‰ç±»åˆ«ç­›é€‰å‘½ä»¤
        function filterCommandsByCategory() {
            const selectedCategory = document.getElementById('category-filter').value;
            
            if (selectedCategory) {
                predefinedCommands = allPredefinedCommands.filter(cmd => cmd.category === selectedCategory);
            } else {
                predefinedCommands = [...allPredefinedCommands];
            }
            
            updatePredefinedCommandsUI();
        }
        
        // æ›´æ–°å‘½ä»¤æè¿°
        function updateCommandDescription() {
            const select = document.getElementById('predefined-select');
            const descriptionDiv = document.getElementById('command-description');
            
            if (select.value === '') {
                descriptionDiv.style.display = 'none';
                return;
            }
            
            const selectedIndex = parseInt(select.value);
            const selectedCommand = predefinedCommands[selectedIndex];
            
            if (selectedCommand) {
                descriptionDiv.innerHTML = `
                    <strong>å‘½ä»¤:</strong> <code>${selectedCommand.command}</code><br>
                    <strong>æè¿°:</strong> ${selectedCommand.description}
                `;
                descriptionDiv.style.display = 'block';
            } else {
                descriptionDiv.style.display = 'none';
            }
        }
        
        // ä¿®æ”¹executeCommandå‡½æ•°ä»¥æ”¯æŒé¢„å®šä¹‰å‘½ä»¤
        function getSelectedCommand() {
            const predefinedRadio = document.getElementById('predefined-cmd');
            
            if (predefinedRadio.checked) {
                // ä½¿ç”¨é¢„å®šä¹‰å‘½ä»¤
                const select = document.getElementById('predefined-select');
                if (select.value === '') {
                    throw new Error('è¯·é€‰æ‹©ä¸€ä¸ªé¢„å®šä¹‰å‘½ä»¤');
                }
                
                const selectedIndex = parseInt(select.value);
                const selectedCommand = predefinedCommands[selectedIndex];
                return selectedCommand.command;
            } else {
                // ä½¿ç”¨è‡ªå®šä¹‰å‘½ä»¤
                const commandInput = document.getElementById('command-input');
                const command = commandInput.value.trim();
                if (!command) {
                    throw new Error('è¯·è¾“å…¥å‘½ä»¤');
                }
                return command;
            }
        }
        
        // è·å–æ‰€æœ‰å®¢æˆ·ç«¯çš„åº”ç”¨ä¿¡æ¯
        async function fetchAppsInfo() {
            try {
                // åŒæ—¶è·å–åº”ç”¨ä¿¡æ¯å’Œå®¢æˆ·ç«¯ä¿¡æ¯
                const [appsResponse, clientsResponse] = await Promise.all([
                    fetch('/api/apps'),
                    fetch('/api/clients')
                ]);
                
                const appsData = await appsResponse.json();
                const clientsData = await clientsResponse.json();
                
                displayAppsInfo(appsData.client_apps, clientsData.clients);
                
                // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
                document.getElementById('apps-last-update').textContent = 
                    `æœ€åæ›´æ–°: ${new Date().toLocaleString('zh-CN')}`;
            } catch (error) {
                console.error('è·å–åº”ç”¨ä¿¡æ¯å¤±è´¥:', error);
                showMessage('è·å–åº”ç”¨ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
                document.getElementById('apps-container').innerHTML = 
                    '<p style="color: red;">è·å–åº”ç”¨ä¿¡æ¯å¤±è´¥</p>';
            }
        }

        // æ˜¾ç¤ºåº”ç”¨ä¿¡æ¯
        function displayAppsInfo(clientApps, clients) {
            const container = document.getElementById('apps-container');
            
            if (!clientApps || Object.keys(clientApps).length === 0) {
                container.innerHTML = '<div class="no-apps">æš‚æ— å®¢æˆ·ç«¯åº”ç”¨ä¿¡æ¯</div>';
                return;
            }

            const html = Object.values(clientApps).map(clientAppInfo => {
                const { client_id, hostname, apps } = clientAppInfo;
                
                // è·å–å®¢æˆ·ç«¯ä¿¡æ¯æ¥åˆ¤æ–­çŠ¶æ€
                const clientData = clients ? Object.values(clients).find(client => 
                    client.system_info && client.system_info.hostname === hostname) : null;
                
                let statusClass = 'status-online';
                let statusText = 'åœ¨çº¿';
                let clientStyle = '';
                
                if (clientData) {
                    const clientStatus = getClientStatus(clientData.last_seen);
                    statusClass = clientStatus.status === 'online' ? 'status-online' : 'status-offline';
                    statusText = clientStatus.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿';
                    if (clientStatus.status === 'offline') {
                        clientStyle = 'opacity: 0.6; border: 2px solid #e74c3c;';
                    }
                }
                
                let appsHtml = '';
                if (apps && apps.length > 0) {
                    appsHtml = apps.map(app => `
                        <div class="app-item">
                            <div class="app-name">${app.name}</div>
                            <div class="app-details">
                                <div><strong>ç‰ˆæœ¬:</strong> <span class="app-version">${app.version}</span></div>
                                <div><strong>éƒ¨ç½²æ—¶é—´:</strong> ${app.deploy_time}</div>
                                ${app.branch ? `<div><strong>åˆ†æ”¯:</strong> ${app.branch}</div>` : ''}
                                ${app.commit ? `<div><strong>æäº¤:</strong> <code>${app.commit}</code></div>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    appsHtml = '<div class="no-apps">è¯¥å®¢æˆ·ç«¯æš‚æ— åº”ç”¨éƒ¨ç½²</div>';
                }

                return `
                    <div class="client-apps" style="${clientStyle}">
                        <h3>
                            <span class="status-indicator ${statusClass}"></span>
                            ${hostname}
                            <small style="color: ${statusText === 'åœ¨çº¿' ? '#27ae60' : '#e74c3c'}; font-weight: normal;">
                                (${client_id.substring(0, 8)}...) - ${statusText}
                            </small>
                        </h3>
                        ${appsHtml}
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="app-grid">${html}</div>`;
        }

        // æ‰‹åŠ¨åˆ·æ–°åº”ç”¨ä¿¡æ¯
        function refreshAppsInfo() {
            document.getElementById('apps-container').innerHTML = '<p>æ­£åœ¨åˆ·æ–°åº”ç”¨ä¿¡æ¯...</p>';
            fetchAppsInfo();
        }
        
        // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        function showTab(tabId) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabId).classList.add('active');

            // æ·»åŠ é€‰ä¸­æŒ‰é’®çš„activeç±»
            event.target.classList.add('active');

            // å¦‚æœåˆ‡æ¢åˆ°åº”ç”¨ç®¡ç†æ ‡ç­¾ï¼Œåˆ·æ–°æ•°æ®
            if (tabId === 'app-management-tab') {
                refreshAppsManagement();
            }
        }

        // åº”ç”¨ç®¡ç†ç›¸å…³å˜é‡
        let currentUpdateContext = {};
        let originalAppsData = null; // å­˜å‚¨åŸå§‹åº”ç”¨æ•°æ®ç”¨äºè¿‡æ»¤
        let originalClientsData = null; // å­˜å‚¨åŸå§‹å®¢æˆ·ç«¯æ•°æ®ç”¨äºè¿‡æ»¤

        // åˆ·æ–°åº”ç”¨ç®¡ç†æ•°æ®
        async function refreshAppsManagement() {
            const container = document.getElementById('app-management-container');
            container.innerHTML = '<p>æ­£åœ¨åŠ è½½åº”ç”¨ç®¡ç†æ•°æ®...</p>';

            try {
                const [appsResponse, clientsResponse] = await Promise.all([
                    fetch('/api/apps'),
                    fetch('/api/clients')
                ]);
                
                const appsData = await appsResponse.json();
                const clientsData = await clientsResponse.json();
                
                // å­˜å‚¨åŸå§‹æ•°æ®ç”¨äºè¿‡æ»¤
                originalAppsData = appsData.client_apps;
                originalClientsData = clientsData.clients;
                
                // æ›´æ–°è¿‡æ»¤å™¨é€‰é¡¹
                updateFilterOptions(originalAppsData, originalClientsData);
                
                displayAppsManagement(originalAppsData, originalClientsData);
                
                document.getElementById('app-management-last-update').textContent = 
                    `æœ€åæ›´æ–°: ${new Date().toLocaleString('zh-CN')}`;
            } catch (error) {
                console.error('è·å–åº”ç”¨ç®¡ç†æ•°æ®å¤±è´¥:', error);
                showMessage('è·å–åº”ç”¨ç®¡ç†æ•°æ®å¤±è´¥: ' + error.message, 'error');
                container.innerHTML = '<p style="color: red;">è·å–åº”ç”¨ç®¡ç†æ•°æ®å¤±è´¥</p>';
            }
        }

        // æ˜¾ç¤ºåº”ç”¨ç®¡ç†è¡¨æ ¼
        function displayAppsManagement(clientApps, clients) {
            const container = document.getElementById('app-management-container');
            
            if (!clientApps || Object.keys(clientApps).length === 0) {
                container.innerHTML = '<div class="no-apps">æš‚æ— åº”ç”¨æ•°æ®</div>';
                return;
            }

            let tableRows = '';
            
            Object.values(clientApps).forEach(clientAppInfo => {
                const { client_id, hostname, apps } = clientAppInfo;
                
                // è·å–å®¢æˆ·ç«¯çŠ¶æ€
                const clientData = clients ? Object.values(clients).find(client => 
                    client.system_info && client.system_info.hostname === hostname) : null;
                
                let clientStatusClass = 'status-online';
                let clientStatusText = 'åœ¨çº¿';
                
                if (clientData) {
                    const clientStatus = getClientStatus(clientData.last_seen);
                    clientStatusClass = clientStatus.status === 'online' ? 'status-online' : 'status-offline';
                    clientStatusText = clientStatus.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿';
                }

                if (apps && apps.length > 0) {
                    apps.forEach(app => {
                        const serviceStatus = getServiceStatusDisplay(app.service_status);
                        const serviceAction = getServiceAction(app.service_status);
                        
                        tableRows += `
                            <tr>
                                <td>
                                    <span class="status-indicator ${clientStatusClass}"></span>
                                    ${hostname}
                                    <small style="color: ${clientStatusText === 'åœ¨çº¿' ? '#27ae60' : '#e74c3c'};">
                                        (${client_id.substring(0, 8)}...) - ${clientStatusText}
                                    </small>
                                </td>
                                <td>${app.name}</td>
                                <td><span class="app-version">${app.version}</span></td>
                                <td>${app.deploy_time}</td>
                                <td>
                                    <span class="service-status ${serviceStatus.class}">${serviceStatus.text}</span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn btn-update" onclick="showUpdateModal('${client_id}', '${hostname}', '${app.name}', '${app.version}')">æ›´æ–°</button>
                                        <button class="action-btn ${serviceAction.class}" onclick="manageService('${client_id}', '${app.name}', '${serviceAction.action}')">${serviceAction.text}</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    tableRows += `
                        <tr>
                            <td>
                                <span class="status-indicator ${clientStatusClass}"></span>
                                ${hostname}
                                <small style="color: ${clientStatusText === 'åœ¨çº¿' ? '#27ae60' : '#e74c3c'};">
                                    (${client_id.substring(0, 8)}...) - ${clientStatusText}
                                </small>
                            </td>
                            <td colspan="5" style="color: #999; font-style: italic;">è¯¥å®¢æˆ·ç«¯æš‚æ— åº”ç”¨éƒ¨ç½²</td>
                        </tr>
                    `;
                }
            });

            const table = `
                <table class="app-management-table">
                    <thead>
                        <tr>
                            <th>å®¢æˆ·ç«¯</th>
                            <th>åº”ç”¨åç§°</th>
                            <th>ç‰ˆæœ¬</th>
                            <th>éƒ¨ç½²æ—¶é—´</th>
                            <th>æœåŠ¡çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;

            container.innerHTML = table;
        }

        // è·å–æœåŠ¡çŠ¶æ€æ˜¾ç¤ºä¿¡æ¯
        function getServiceStatusDisplay(serviceStatus) {
            if (typeof serviceStatus === 'string') {
                // å¤„ç†å­—ç¬¦ä¸²æ ¼å¼çš„çŠ¶æ€
                switch (serviceStatus.toLowerCase()) {
                    case 'running':
                        return { class: 'status-running', text: 'è¿è¡Œä¸­' };
                    case 'stopped':
                        return { class: 'status-stopped', text: 'å·²åœæ­¢' };
                    default:
                        return { class: 'status-unknown', text: 'æœªçŸ¥' };
                }
            } else if (typeof serviceStatus === 'object') {
                // å¤„ç†å¯¹è±¡æ ¼å¼çš„çŠ¶æ€
                if (serviceStatus.Running) {
                    return { class: 'status-running', text: `è¿è¡Œä¸­ (PID: ${serviceStatus.Running})` };
                } else if (serviceStatus.Stopped) {
                    return { class: 'status-stopped', text: 'å·²åœæ­¢' };
                } else if (serviceStatus.Unknown) {
                    return { class: 'status-unknown', text: 'æœªçŸ¥' };
                }
            }
            return { class: 'status-unknown', text: 'æœªçŸ¥' };
        }

        // è·å–æœåŠ¡æ“ä½œä¿¡æ¯
        function getServiceAction(serviceStatus) {
            const isRunning = (typeof serviceStatus === 'string' && serviceStatus.toLowerCase() === 'running') ||
                             (typeof serviceStatus === 'object' && serviceStatus.Running);
            
            return isRunning 
                ? { class: 'btn-stop', text: 'åœæ­¢æœåŠ¡', action: 'Stop' }
                : { class: 'btn-start', text: 'å¯åŠ¨æœåŠ¡', action: 'Start' };
        }

        // æ˜¾ç¤ºæ›´æ–°æ¨¡æ€æ¡†
        function showUpdateModal(clientId, hostname, appName, currentVersion) {
            currentUpdateContext = { clientId, hostname, appName, currentVersion };
            
            document.getElementById('update-client-info').textContent = `${hostname} (${clientId.substring(0, 8)}...)`;
            document.getElementById('update-app-info').textContent = `${appName} (å½“å‰ç‰ˆæœ¬: ${currentVersion})`;
            document.getElementById('update-version').value = '';
            
            document.getElementById('update-modal').style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ç¡®è®¤æ›´æ–°
        async function confirmUpdate() {
            const newVersion = document.getElementById('update-version').value.trim();
            if (!newVersion) {
                showMessage('è¯·è¾“å…¥æ–°ç‰ˆæœ¬å·', 'error');
                return;
            }

            const { clientId, appName } = currentUpdateContext;
            
            try {
                const response = await fetch('/api/update-app', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: clientId,
                        app_name: appName,
                        version: newVersion
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage(`æ›´æ–°å‘½ä»¤å·²å‘é€: ${result.message}`, 'success');
                    closeModal('update-modal');
                    
                    // å¯ä»¥é€‰æ‹©æ€§åœ°è½®è¯¢å‘½ä»¤ç»“æœ
                    if (result.command_id) {
                        pollCommandResult(result.command_id);
                    }
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
            } catch (error) {
                showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç®¡ç†æœåŠ¡ï¼ˆå¯åŠ¨/åœæ­¢ï¼‰
        async function manageService(clientId, appName, action) {
            const actionText = action === 'Start' ? 'å¯åŠ¨' : 'åœæ­¢';
            
            if (!confirm(`ç¡®å®šè¦${actionText}æœåŠ¡ "${appName}" å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch('/api/manage-service', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: clientId,
                        app_name: appName,
                        action: action
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage(`${actionText}æœåŠ¡å‘½ä»¤å·²å‘é€: ${result.message}`, 'success');
                    
                    // å¯ä»¥é€‰æ‹©æ€§åœ°è½®è¯¢å‘½ä»¤ç»“æœ
                    if (result.command_id) {
                        pollCommandResult(result.command_id);
                    }

                    // å»¶è¿Ÿåˆ·æ–°åº”ç”¨ç®¡ç†æ•°æ®ä»¥æ˜¾ç¤ºæ–°çŠ¶æ€
                    setTimeout(() => {
                        refreshAppsManagement();
                    }, 2000);
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
            } catch (error) {
                showMessage(`${actionText}æœåŠ¡å¤±è´¥: ` + error.message, 'error');
            }
        }

        // è¿‡æ»¤åŠŸèƒ½ç›¸å…³å‡½æ•°
        
        // æ›´æ–°è¿‡æ»¤å™¨é€‰é¡¹
        function updateFilterOptions(clientApps, clients) {
            const clientFilter = document.getElementById('filter-client');
            const currentClientValue = clientFilter.value;
            
            // ä¿ç•™ç¬¬ä¸€ä¸ªé»˜è®¤é€‰é¡¹
            clientFilter.innerHTML = '<option value="">å…¨éƒ¨å®¢æˆ·ç«¯</option>';
            
            if (clientApps) {
                Object.values(clientApps).forEach(clientAppInfo => {
                    const option = document.createElement('option');
                    option.value = clientAppInfo.client_id;
                    option.textContent = `${clientAppInfo.hostname} (${clientAppInfo.client_id.substring(0, 8)}...)`;
                    clientFilter.appendChild(option);
                });
                
                // æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼
                if (currentClientValue) {
                    clientFilter.value = currentClientValue;
                }
            }
        }
        
        // åº”ç”¨è¿‡æ»¤å™¨
        function applyFilters() {
            if (!originalAppsData || !originalClientsData) {
                return;
            }
            
            const clientFilter = document.getElementById('filter-client').value.toLowerCase();
            const appNameFilter = document.getElementById('filter-app-name').value.toLowerCase().trim();
            const statusFilter = document.getElementById('filter-status').value;
            const serviceStatusFilter = document.getElementById('filter-service-status').value;
            
            let filteredAppsData = {};
            let totalApps = 0;
            let filteredApps = 0;
            
            Object.values(originalAppsData).forEach(clientAppInfo => {
                const { client_id, hostname, apps } = clientAppInfo;
                
                // è·å–å®¢æˆ·ç«¯çŠ¶æ€
                const clientData = originalClientsData ? Object.values(originalClientsData).find(client => 
                    client.system_info && client.system_info.hostname === hostname) : null;
                
                let clientStatus = 'offline';
                if (clientData) {
                    const status = getClientStatus(clientData.last_seen);
                    clientStatus = status.status;
                }
                
                // è¿‡æ»¤å®¢æˆ·ç«¯
                if (clientFilter && client_id.toLowerCase() !== clientFilter) {
                    return;
                }
                
                // è¿‡æ»¤å®¢æˆ·ç«¯çŠ¶æ€
                if (statusFilter && clientStatus !== statusFilter) {
                    return;
                }
                
                let filteredClientApps = [];
                
                if (apps && apps.length > 0) {
                    totalApps += apps.length;
                    
                    apps.forEach(app => {
                        // è¿‡æ»¤åº”ç”¨åç§°
                        if (appNameFilter && !app.name.toLowerCase().includes(appNameFilter)) {
                            return;
                        }
                        
                        // è¿‡æ»¤æœåŠ¡çŠ¶æ€
                        if (serviceStatusFilter) {
                            const appServiceStatus = getServiceStatusType(app.service_status);
                            if (appServiceStatus !== serviceStatusFilter) {
                                return;
                            }
                        }
                        
                        filteredClientApps.push(app);
                        filteredApps++;
                    });
                }
                
                // å¦‚æœåº”ç”¨åç§°è¿‡æ»¤å™¨æœ‰å€¼ä½†è¯¥å®¢æˆ·ç«¯æ²¡æœ‰åŒ¹é…çš„åº”ç”¨ï¼Œåˆ™ä¸æ˜¾ç¤ºè¯¥å®¢æˆ·ç«¯
                if (appNameFilter && filteredClientApps.length === 0 && apps && apps.length > 0) {
                    return;
                }
                
                // æ·»åŠ åˆ°è¿‡æ»¤ç»“æœ
                filteredAppsData[client_id] = {
                    client_id,
                    hostname,
                    apps: filteredClientApps
                };
            });
            
            // æ˜¾ç¤ºè¿‡æ»¤ç»“æœ
            displayAppsManagement(filteredAppsData, originalClientsData);
            
            // æ›´æ–°è¿‡æ»¤ç»“æœä¿¡æ¯
            updateFilterResultsInfo(filteredApps, totalApps);
        }
        
        // è·å–æœåŠ¡çŠ¶æ€ç±»å‹ï¼ˆç”¨äºè¿‡æ»¤ï¼‰
        function getServiceStatusType(serviceStatus) {
            if (typeof serviceStatus === 'string') {
                return serviceStatus.toLowerCase();
            } else if (typeof serviceStatus === 'object') {
                if (serviceStatus.Running) {
                    return 'running';
                } else if (serviceStatus.Stopped) {
                    return 'stopped';
                } else if (serviceStatus.Unknown) {
                    return 'unknown';
                }
            }
            return 'unknown';
        }
        
        // æ›´æ–°è¿‡æ»¤ç»“æœä¿¡æ¯
        function updateFilterResultsInfo(filteredCount, totalCount) {
            const infoElement = document.getElementById('filter-results-info');
            if (filteredCount !== totalCount) {
                infoElement.textContent = `æ˜¾ç¤º ${filteredCount} / ${totalCount} ä¸ªåº”ç”¨`;
                infoElement.style.color = '#007bff';
                infoElement.style.fontWeight = 'bold';
            } else {
                infoElement.textContent = `æ˜¾ç¤ºå…¨éƒ¨ ${totalCount} ä¸ªåº”ç”¨`;
                infoElement.style.color = '#666';
                infoElement.style.fontWeight = 'normal';
            }
        }
        
        // æ¸…ç©ºè¿‡æ»¤å™¨
        function clearFilters() {
            document.getElementById('filter-client').value = '';
            document.getElementById('filter-app-name').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-service-status').value = '';
            
            // é‡æ–°æ˜¾ç¤ºåŸå§‹æ•°æ®
            if (originalAppsData && originalClientsData) {
                displayAppsManagement(originalAppsData, originalClientsData);
                
                // æ›´æ–°ç»“æœä¿¡æ¯
                let totalApps = 0;
                Object.values(originalAppsData).forEach(clientAppInfo => {
                    if (clientAppInfo.apps && clientAppInfo.apps.length > 0) {
                        totalApps += clientAppInfo.apps.length;
                    }
                });
                updateFilterResultsInfo(totalApps, totalApps);
            }
        }

        // æ´»åŠ¨ç›‘æ§ç›¸å…³åŠŸèƒ½
        function startActivityMonitoring() {
            // è®°å½•æ´»åŠ¨æ—¶é—´
            updateLastActivity();
            
            // ç›‘å¬ç”¨æˆ·æ´»åŠ¨äº‹ä»¶
            const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            activityEvents.forEach(event => {
                document.addEventListener(event, updateLastActivity, { passive: true });
            });
            
            // å®šæœŸæ£€æŸ¥ä¼šè¯çŠ¶æ€
            activityCheckInterval = setInterval(checkSessionStatus, ACTIVITY_CHECK_INTERVAL);
            
            // è®¾ç½®ä¼šè¯è¶…æ—¶å®šæ—¶å™¨
            resetSessionTimeout();
        }
        
        function stopActivityMonitoring() {
            // æ¸…é™¤å®šæ—¶å™¨
            if (sessionTimeoutId) {
                clearTimeout(sessionTimeoutId);
                sessionTimeoutId = null;
            }
            if (activityCheckInterval) {
                clearInterval(activityCheckInterval);
                activityCheckInterval = null;
            }
            
            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
            const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            activityEvents.forEach(event => {
                document.removeEventListener(event, updateLastActivity, { passive: true });
            });
        }
        
        function updateLastActivity() {
            lastActivity = new Date();
            // é‡ç½®ä¼šè¯è¶…æ—¶å®šæ—¶å™¨
            resetSessionTimeout();
        }
        
        function resetSessionTimeout() {
            if (sessionTimeoutId) {
                clearTimeout(sessionTimeoutId);
            }
            
            sessionTimeoutId = setTimeout(() => {
                handleAutoLogout('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
            }, SESSION_TIMEOUT);
        }
        
        function checkSessionStatus() {
            if (!isAuthenticated || !lastActivity) {
                return;
            }
            
            const now = new Date();
            const timeSinceLastActivity = now - lastActivity;
            const timeUntilLogout = SESSION_TIMEOUT - timeSinceLastActivity;
            
            // å¦‚æœè·ç¦»è‡ªåŠ¨ç™»å‡ºè¿˜æœ‰WARNING_TIMEæ—¶é—´ï¼Œæ˜¾ç¤ºè­¦å‘Š
            if (timeUntilLogout <= WARNING_TIME && timeUntilLogout > 0) {
                const minutesLeft = Math.ceil(timeUntilLogout / (60 * 1000));
                showMessage(`æ‚¨çš„ä¼šè¯å°†åœ¨ ${minutesLeft} åˆ†é’Ÿåè¿‡æœŸï¼Œè¯·è¿›è¡Œä»»æ„æ“ä½œä»¥å»¶é•¿ä¼šè¯`, 'info');
            }
            
            // å®šæœŸæ£€æŸ¥æœåŠ¡å™¨ç«¯çš„è®¤è¯çŠ¶æ€
            if (timeSinceLastActivity < 30 * 60 * 1000) { // ä»…30åˆ†é’Ÿå†…æœ‰æ´»åŠ¨æ‰æ£€æŸ¥æœåŠ¡å™¨è®¤è¯
                checkAuthStatus();
            }
        }
        
        function handleAutoLogout(reason) {
            setUnauthenticatedState();
            showMessage(reason, 'error');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // é¦–å…ˆæ£€æŸ¥è®¤è¯çŠ¶æ€
            const isAuth = await checkAuthStatus();
            if (!isAuth) {
                setUnauthenticatedState();
            }
        });
    </script>
</body>
</html>
