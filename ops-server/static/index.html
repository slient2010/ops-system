<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>特易行服务管理</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            padding: 15px; 
            background: #f5f5f5; 
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 10px;
        }
        h1 { color: #2c3e50; text-align: center; }
        h2 { color: #333; border-bottom: 2px solid #3498db; padding-bottom: 3px; }
        
        .section { 
            margin: 15px 0; 
            padding: 15px; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
        }
        
        .form-group { margin: 15px 0; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #555;
        }
        
        input, select, textarea, button { 
            padding: 12px; 
            margin: 5px 0; 
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        input[type="text"], select { 
            width: 100%; 
            max-width: 100%;
        }
        
        button { 
            background: #3498db; 
            color: white; 
            border: none; 
            cursor: pointer;
            min-width: 120px;
        }
        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        
        .client-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 15px; 
        }
        .client-card { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 6px; 
            border-left: 4px solid #27ae60;
        }
        .client-card h4 { margin: 0 0 10px 0; color: #2c3e50; }
        .client-info { font-size: 12px; color: #666; }
        
        .command-result { 
            background: #2c3e50; 
            color: #ecf0f1; 
            padding: 15px; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace; 
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status-indicator { 
            display: inline-block; 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            margin-right: 5px;
        }
        .status-online { background: #27ae60; }
        .status-offline { background: #e74c3c; }
        
        .loading { opacity: 0.6; }
        
        /* 消息提示区域 - 右上角固定位置 */
        #message-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
            width: auto;
        }
        
        .alert { 
            padding: 15px 20px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border-left: 4px solid #3498db;
            background: #ebf3fd;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.3s ease-out forwards;
            position: relative;
            padding-right: 45px;
            cursor: pointer;
        }
        
        .alert-success { 
            border-left-color: #27ae60; 
            background: #eafaf1; 
            color: #155724;
        }
        
        .alert-error { 
            border-left-color: #e74c3c; 
            background: #fdf2f2; 
            color: #721c24;
        }
        
        .alert-info {
            border-left-color: #3498db;
            background: #ebf3fd;
            color: #0c5460;
        }
        
        .alert:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        
        /* 关闭按钮 */
        .alert::after {
            content: '×';
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            font-size: 20px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }
        
        .alert:hover::after {
            color: #666;
        }
        
        /* 消息滑入动画 */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* 消息滑出动画 */
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        .alert.slide-out {
            animation: slideOut 0.3s ease-in forwards;
        }
        
        .command-history {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #fafafa;
        }
        .history-item {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #3498db;
            background: white;
            font-size: 12px;
        }

        /* 应用信息样式 */
        .app-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .client-apps {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .client-apps h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .app-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            margin: 8px 0;
        }

        .app-name {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .app-details {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .app-version {
            color: #28a745;
            font-weight: bold;
        }

        .no-apps {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        /* 标签页样式 */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            background: #ffffff;
            border: 1px solid #ddd;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
            border-radius: 6px 6px 0 0;
            color: #666;
        }

        .tab-button.active {
            background: #ffffff;
            border-bottom-color: #3498db;
            color: #3498db;
            font-weight: bold;
            border-color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab-button:hover {
            background: #f0f8ff;
            color: #2980b9;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 应用管理表格样式 */
        .app-management-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .app-management-table th,
        .app-management-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .app-management-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .app-management-table tr:hover {
            background: #f5f5f5;
        }

        /* 命令执行区域样式（与应用管理一致） */
        .command-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .command-form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .command-form-left,
        .command-form-right {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .command-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-top: 20px;
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 16px; /* 防止iOS缩放 */
            }
            
            .container {
                padding: 0 5px;
            }
            
            h1 {
                font-size: 24px;
                margin: 10px 0;
            }
            
            h2 {
                font-size: 18px;
                margin: 15px 0 10px 0;
            }
            
            .section {
                margin: 10px 0;
                padding: 12px;
            }
            
            .tabs {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .tab-button {
                flex: 1;
                min-width: 80px;
                padding: 8px 12px;
                font-size: 12px;
                margin-right: 0;
                margin-bottom: 5px;
            }
            
            .command-form-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .client-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .app-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            input, select, textarea, button {
                padding: 14px; /* 更大的触摸目标 */
                font-size: 16px; /* 防止iOS缩放 */
            }
            
            button {
                min-width: 100px;
                padding: 14px 20px;
            }
            
            .app-management-table {
                font-size: 12px;
            }
            
            .app-management-table th,
            .app-management-table td {
                padding: 8px 4px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            .action-btn {
                min-width: 80px;
                font-size: 11px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 15px;
            }
            
            .command-result {
                font-size: 12px;
                max-height: 200px;
            }
            
            .command-history {
                max-height: 150px;
            }
        }
        
        /* 超小屏幕适配 */
        @media (max-width: 480px) {
            .container {
                padding: 0;
            }
            
            .section {
                margin: 8px 0;
                padding: 10px;
                border-radius: 6px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .tabs {
                justify-content: center;
            }
            
            .tab-button {
                font-size: 11px;
                padding: 6px 8px;
            }
            
            .app-management-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .form-group {
                margin: 10px 0;
            }
            
            input, select, textarea {
                font-size: 16px; /* 防止iOS缩放 */
            }
            
            /* 移动端消息提示调整 */
            #message-area {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            .alert {
                padding: 12px 15px;
                padding-right: 40px;
                font-size: 14px;
            }
            
            .alert::after {
                font-size: 18px;
                right: 12px;
            }
        }
        
        /* 中等屏幕适配 (平板) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 95%;
            }
            
            .app-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
            
            .client-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
            
            .command-form-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        /* 大屏幕优化 */
        @media (min-width: 1025px) {
            .container {
                max-width: 1200px;
            }
        }

        /* 登录界面样式 */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 400px;
            max-width: 90%;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: #2c3e50;
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .login-header p {
            color: #666;
            margin: 0;
            font-size: 14px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-form .form-group {
            margin: 0;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .login-form input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .login-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .login-btn:hover {
            background: #2980b9;
        }

        .login-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .login-error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
            margin-top: 15px;
            font-size: 14px;
        }

        /* 顶部状态栏 */
        .auth-status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #2c3e50;
            color: white;
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            font-size: 14px;
        }

        .auth-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        /* 调整页面内容位置，为状态栏留出空间 */
        body.authenticated {
            padding-top: 40px;
        }

        .authenticated .container {
            margin-top: 0;
        }

        .service-status {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-running {
            background: #d4edda;
            color: #155724;
        }

        .status-stopped {
            background: #f8d7da;
            color: #721c24;
        }

        .status-unknown {
            background: #fff3cd;
            color: #856404;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            min-width: 60px;
        }

        .btn-update {
            background: #007bff;
            color: white;
        }

        .btn-start {
            background: #28a745;
            color: white;
        }

        .btn-stop {
            background: #dc3545;
            color: white;
        }

        .btn-update:hover { background: #0056b3; }
        .btn-start:hover { background: #1e7e34; }
        .btn-stop:hover { background: #bd2130; }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: none;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }
    </style>
</head>
<body>
    <!-- 登录界面 -->
    <div id="login-container" class="login-container" style="display: none;">
        <div class="login-box">
            <div class="login-header">
                <h2>🔐 特易行服务管理</h2>
                <p>请输入您的登录凭据</p>
            </div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username">用户名</label>
                    <input type="text" id="username" name="username" placeholder="请输入用户名" required>
                </div>
                <div class="form-group">
                    <label for="password">密码</label>
                    <input type="password" id="password" name="password" placeholder="请输入密码" required>
                </div>
                <button type="submit" id="login-btn" class="login-btn">登录</button>
                <div id="login-error" class="login-error" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- 认证状态栏 -->
    <div id="auth-status-bar" class="auth-status-bar" style="display: none;">
        <div class="auth-user-info">
            <span>👤 已登录用户: <strong id="current-user">--</strong></span>
            <span>🕐 登录时间: <span id="login-time">--</span></span>
        </div>
        <button class="logout-btn" onclick="handleLogout()">登出</button>
    </div>

    <!-- 消息提示区域 -->
    <div id="message-area"></div>

    <!-- 主内容区域 -->
    <div id="main-content" class="container" style="display: none;">
        <h1>特易行服务管理</h1>
        
        <!-- 系统状态概览 -->
        <div class="section">
            <h2>系统状态</h2>
            <div style="display: flex; gap: 20px; align-items: center;">
                <div>在线客户端: <strong id="online-count">0</strong></div>
                <div>最后更新: <span id="last-update">-</span></div>
                <div>
                    <span class="status-indicator status-online"></span>
                    服务器运行中
                </div>
            </div>
        </div>

        <!-- 标签页导航 -->
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('system-info-tab')">系统信息</button>
            <button class="tab-button" onclick="showTab('app-management-tab')">应用管理</button>
            <button class="tab-button" onclick="showTab('command-tab')">命令执行</button>
	    <!--
            <button class="tab-button" onclick="showTab('broadcast-tab')">广播消息</button>
	    -->
        </div>

        <!-- 系统信息标签页 -->
        <div id="system-info-tab" class="section tab-content active">
            <!-- 应用部署信息 -->
            <div style="margin-bottom: 30px;">
                <h2>应用部署信息</h2>
                <div style="margin-bottom: 10px;">
                    <button onclick="refreshAppsInfo()" style="padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">刷新应用信息</button>
                    <span id="apps-last-update" style="margin-left: 15px; color: #666; font-size: 12px;"></span>
                </div>
                <div id="apps-container">
                    <p>正在加载应用信息...</p>
                </div>
            </div>

            <!-- 客户端列表 -->
            <div>
                <h2>客户端列表</h2>
                <div id="clients" class="client-grid"></div>
            </div>
        </div>

        <!-- 命令执行区域 -->
        <div id="command-tab" class="section tab-content">
            <h2>命令执行</h2>
            
            <div class="command-section">
                <div class="command-form-container">
                    <div class="command-form-left">
                        <div class="form-group">
                            <label for="client-select">选择客户端:</label>
                            <select id="client-select">
                                <option value="">-- 选择客户端 --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>命令类型:</label>
                            <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 20px;">
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <input type="radio" id="predefined-cmd" name="command-type" value="predefined" checked onchange="toggleCommandType()">
                                    <label for="predefined-cmd" style="margin: 0;">预定义命令</label>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <input type="radio" id="custom-cmd" name="command-type" value="custom" onchange="toggleCommandType()">
                                    <label for="custom-cmd" style="margin: 0;">自定义命令</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="command-form-right">
                        <!-- 预定义命令选择 -->
                        <div id="predefined-commands-section" class="form-group">
                            <label for="predefined-select">选择预定义命令:</label>
                            <select id="predefined-select" onchange="updateCommandDescription()">
                                <option value="">-- 选择预定义命令 --</option>
                            </select>
                            <div id="command-description" style="margin-top: 5px; font-size: 12px; color: #666; display: none;"></div>
                            
			    <!--
                            <div style="margin-top: 10px;">
                                <label for="category-filter">按类别筛选:</label>
                                <select id="category-filter" onchange="filterCommandsByCategory()">
                                    <option value="">所有类别</option>
                                </select>
                            </div>
			    -->
                        </div>
                        
                        <!-- 自定义命令输入 -->
                        <div id="custom-command-section" class="form-group" style="display: none;">
                            <label for="command-input">自定义命令:</label>
                            <input type="text" id="command-input" placeholder="输入要执行的命令 (如: ps aux, ls -la)" 
                                   onkeypress="handleCommandKeyPress(event)">
                            <div style="margin-top: 5px; font-size: 12px; color: #e74c3c;">
                                ⚠️ 自定义命令将进行安全验证，危险命令将被拒绝执行
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="command-controls">
                    <button id="execute-btn" onclick="executeCommand()" style="padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; min-width: 120px;">执行命令</button>
                    <button onclick="clearResult()" style="padding: 8px 15px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">清空结果</button>
                </div>
            </div>
            
            <!-- 命令执行结果 -->
            <div id="command-result-section" style="display: none;">
                <h3>执行结果:</h3>
                <div id="command-result" class="command-result">等待命令执行...</div>
            </div>
            
            <!-- 命令历史 -->
            <div>
                <h3>命令历史:</h3>
                <div id="command-history" class="command-history">
                    <div class="history-item">暂无历史记录</div>
                </div>
            </div>
        </div>


        <!-- 应用管理标签页 -->
        <div id="app-management-tab" class="section tab-content">
            <!-- 应用管理 -->
            <div style="margin-bottom: 30px;">
                <h2>应用管理</h2>
                <div style="margin-bottom: 10px;">
                    <button onclick="refreshAppsManagement()" style="padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">刷新数据</button>
                    <span id="app-management-last-update" style="margin-left: 15px; color: #666; font-size: 12px;"></span>
                </div>
                
                <!-- 过滤器区域 -->
                <div class="filter-section" style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;">筛选条件</h3>
                    <div class="filter-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label for="filter-client">客户端:</label>
                            <select id="filter-client" onchange="applyFilters()">
                                <option value="">全部客户端</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filter-app-name">应用名称:</label>
                            <input type="text" id="filter-app-name" placeholder="输入应用名称" oninput="applyFilters()">
                        </div>
                        <div class="form-group">
                            <label for="filter-status">状态:</label>
                            <select id="filter-status" onchange="applyFilters()">
                                <option value="">全部状态</option>
                                <option value="online">在线</option>
                                <option value="offline">离线</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filter-service-status">服务状态:</label>
                            <select id="filter-service-status" onchange="applyFilters()">
                                <option value="">全部服务状态</option>
                                <option value="running">运行中</option>
                                <option value="stopped">已停止</option>
                                <option value="unknown">未知</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="clearFilters()" style="padding: 5px 15px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">清空筛选</button>
                        <span id="filter-results-info" style="margin-left: 15px; color: #666; font-size: 14px;"></span>
                    </div>
                </div>
                
                <div id="app-management-container">
                    <p>正在加载应用管理数据...</p>
                </div>
            </div>
        </div>

        <!-- 广播消息标签页 -->
	<!--
        <div id="broadcast-tab" class="section tab-content">
            <div style="margin-bottom: 30px;">
                <h2>广播消息</h2>
                <div class="form-group">
                    <label for="broadcast-message">消息内容:</label>
                    <input type="text" id="broadcast-message" placeholder="输入要广播给所有客户端的消息">
                </div>
                <div class="form-group">
                    <button onclick="sendBroadcast()">发送广播</button>
                </div>
            </div>
        </div>
	-->
        
        </div>

        <!-- 更新应用模态框 -->
        <div id="update-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>更新应用</h3>
                    <span class="close" onclick="closeModal('update-modal')">&times;</span>
                </div>
                <div class="form-group">
                    <label>客户端:</label>
                    <div id="update-client-info"></div>
                </div>
                <div class="form-group">
                    <label>应用名称:</label>
                    <div id="update-app-info"></div>
                </div>
                <div class="form-group">
                    <label for="update-version">新版本:</label>
                    <input type="text" id="update-version" placeholder="输入新版本号 (如: v1.2.0)">
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button onclick="closeModal('update-modal')" style="margin-right: 10px; background: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">取消</button>
                    <button onclick="confirmUpdate()" style="background: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">确认更新</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let commandHistory = [];
        let pendingCommands = new Map(); // 跟踪待执行的命令
        let predefinedCommands = []; // 存储预定义命令
        let allPredefinedCommands = []; // 存储所有预定义命令（用于筛选）
        let isAuthenticated = false; // 认证状态
        let currentUser = null; // 当前用户
        let loginTime = null; // 登录时间
        let lastActivity = null; // 最后活动时间
        let sessionTimeoutId = null; // 会话超时定时器
        let activityCheckInterval = null; // 活动检查定时器
        const SESSION_TIMEOUT = 60 * 60 * 1000; // 1小时 (60 * 60 * 1000ms)
        const ACTIVITY_CHECK_INTERVAL = 60 * 1000; // 每1分钟检查一次 (60 * 1000ms)
        const WARNING_TIME = 5 * 60 * 1000; // 提前5分钟警告 (5 * 60 * 1000ms)

        // 认证相关函数
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/check-auth', {
                    credentials: 'include' // 包含 cookies
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        setAuthenticatedState(result.session_id);
                        return true;
                    }
                }
            } catch (error) {
                console.error('检查认证状态失败:', error);
            }
            
            setUnauthenticatedState();
            return false;
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('login-btn');
            const errorDiv = document.getElementById('login-error');
            
            // 禁用登录按钮
            loginBtn.disabled = true;
            loginBtn.textContent = '登录中...';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    setAuthenticatedState(result.session_id, username);
                    showMessage('登录成功，欢迎使用特易行服务管理系统！', 'success');
                } else {
                    errorDiv.textContent = result.message;
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = '登录请求失败，请检查网络连接';
                errorDiv.style.display = 'block';
                console.error('登录错误:', error);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = '登录';
            }
        }

        async function handleLogout() {
            if (!confirm('确定要退出登录吗？')) {
                return;
            }
            
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('登出请求失败:', error);
            }
            
            setUnauthenticatedState();
            showMessage('已成功退出登录', 'info');
        }

        function setAuthenticatedState(sessionId, username = 'admin') {
            isAuthenticated = true;
            currentUser = username;
            loginTime = new Date();
            lastActivity = new Date();
            
            // 更新UI
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('auth-status-bar').style.display = 'flex';
            document.getElementById('main-content').style.display = 'block';
            document.body.classList.add('authenticated');
            
            // 更新状态栏信息
            document.getElementById('current-user').textContent = currentUser;
            document.getElementById('login-time').textContent = loginTime.toLocaleString('zh-CN');
            
            // 启动活动监控
            startActivityMonitoring();
            
            // 初始化主要功能
            initializeApp();
        }

        function setUnauthenticatedState() {
            isAuthenticated = false;
            currentUser = null;
            loginTime = null;
            lastActivity = null;
            
            // 停止活动监控
            stopActivityMonitoring();
            
            // 更新UI
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('auth-status-bar').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
            document.body.classList.remove('authenticated');
            
            // 清空表单
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-error').style.display = 'none';
        }

        function initializeApp() {
            fetchClients();
            fetchPredefinedCommands();
            fetchAppsInfo();
            // 定期刷新客户端列表和应用信息
            setInterval(fetchClients, 30000); // 30秒刷新一次客户端状态
            setInterval(fetchAppsInfo, 30000); // 30秒刷新一次应用信息
            // 如果在应用管理标签页，也定期刷新
            setInterval(() => {
                if (document.getElementById('app-management-tab').classList.contains('active')) {
                    refreshAppsManagement();
                }
            }, 15000); // 15秒刷新一次应用管理数据
        }
        
        // 获取客户端列表
        async function fetchClients() {
            if (!isAuthenticated) {
                return;
            }
            
            try {
                const response = await fetch('/api/clients', {
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    // 认证失效，重新显示登录界面
                    handleAutoLogout('会话已过期，请重新登录');
                    return;
                }
                
                const data = await response.json();
                
                updateClientsList(data.clients);
                updateClientSelect(data.clients);
                updateSystemStatus(data.clients);
                
            } catch (error) {
                showMessage('获取客户端列表失败: ' + error.message, 'error');
            }
        }
        
        // 更新客户端列表显示
        function updateClientsList(clients) {
            const clientsContainer = document.getElementById('clients');
            clientsContainer.innerHTML = '';
            
            if (Object.keys(clients).length === 0) {
                clientsContainer.innerHTML = '<div class="client-card">暂无在线客户端</div>';
                return;
            }
            
            Object.entries(clients).forEach(([id, client]) => {
                const clientCard = document.createElement('div');
                clientCard.className = 'client-card';
                
                // 获取客户端状态
                const clientStatus = getClientStatus(client.last_seen);
                const statusClass = clientStatus.status === 'online' ? 'status-online' : 'status-offline';
                const statusText = clientStatus.status === 'online' ? '在线' : '离线';
                
                // 如果离线，给卡片添加特殊样式
                if (clientStatus.status === 'offline') {
                    clientCard.style.opacity = '0.6';
                    clientCard.style.borderLeftColor = '#e74c3c';
                }
                
                clientCard.innerHTML = `
                    <h4>
                        <span class="status-indicator ${statusClass}"></span>
                        ${client.system_info.hostname} 
                        <small style="color: ${clientStatus.status === 'online' ? '#27ae60' : '#e74c3c'};">(${statusText})</small>
                    </h4>
                    <div class="client-info">
                        <div><strong>客户端ID:</strong> ${id.substring(0, 8)}...</div>
                        <div><strong>CPU:</strong> ${client.system_info.cpu_model}</div>
                        <div><strong>内存:</strong> ${formatBytes(client.system_info.used_memory)} / ${formatBytes(client.system_info.total_memory)}</div>
                        <div><strong>IP地址:</strong> ${client.system_info.ip_addresses.join(', ')}</div>
                        <div><strong>最后心跳:</strong> ${formatTime(client.last_seen)} (${clientStatus.timeAgo})</div>
                        ${clientStatus.diffSeconds > 30 ? '<div style="color: #e74c3c; font-size: 12px;"><strong>⚠️ 客户端可能已断开连接</strong></div>' : ''}
                    </div>
                `;
                clientsContainer.appendChild(clientCard);
            });
        }
        
        // 更新客户端选择下拉框
        function updateClientSelect(clients) {
            const clientSelect = document.getElementById('client-select');
            const currentValue = clientSelect.value;
            
            // 保留第一个默认选项
            clientSelect.innerHTML = '<option value="">-- 选择客户端 --</option>';
            
            Object.entries(clients).forEach(([id, client]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${client.system_info.hostname} (${id.substring(0, 8)})`;
                clientSelect.appendChild(option);
            });
            
            // 恢复之前选中的值
            if (currentValue) {
                clientSelect.value = currentValue;
            }
        }
        
        // 更新系统状态
        function updateSystemStatus(clients) {
            document.getElementById('online-count').textContent = Object.keys(clients).length;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }
        
        // 执行命令
        async function executeCommand() {
            const clientId = document.getElementById('client-select').value;
            let command;
            
            if (!clientId) {
                showMessage('请选择要执行命令的客户端', 'error');
                return;
            }
            
            try {
                command = getSelectedCommand();
            } catch (error) {
                showMessage(error.message, 'error');
                return;
            }
            
            // 添加到历史记录
            addToHistory(clientId, command);
            
            // 显示结果区域和加载状态
            showCommandResult();
            document.getElementById('command-result').textContent = '正在发送命令到客户端...';
            
            // 禁用按钮
            const btn = document.getElementById('execute-btn');
            btn.disabled = true;
            btn.textContent = '执行中...';
            
            try {
                const response = await fetch('/api/send-command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ client_id: clientId, command })
                });
                
                if (response.status === 401) {
                    handleAutoLogout('会话已过期，请重新登录');
                    return;
                }
                
                if (response.ok) {
                    const result = await response.json();
                    const commandId = result.command_id;
                    
                    showMessage('命令发送成功，等待执行结果...', 'success');
                    document.getElementById('command-result').textContent = `命令已发送，正在等待客户端执行...\n命令ID: ${commandId}`;
                    
                    // 开始轮询命令结果
                    pollCommandResult(commandId);
                    
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
                
            } catch (error) {
                showMessage('命令发送失败: ' + error.message, 'error');
                document.getElementById('command-result').textContent = '命令发送失败: ' + error.message;
                
                // 恢复按钮状态
                btn.disabled = false;
                btn.textContent = '执行命令';
            }
        }
        
        // 轮询命令执行结果
        async function pollCommandResult(commandId, maxAttempts = 20) {
            let attempts = 0;
            const pollInterval = 1000; // 1秒轮询一次
            
            const poll = async () => {
                attempts++;
                
                try {
                    const response = await fetch(`/api/command-result?command_id=${commandId}`);
                    
                    if (response.ok) {
                        const status = await response.json();
                        
                        if (status.Completed) {
                            // 命令执行完成
                            const result = status.Completed;
                            displayCommandResult(result);
                            
                            // 恢复按钮状态
                            const btn = document.getElementById('execute-btn');
                            btn.disabled = false;
                            btn.textContent = '执行命令';
                            
                            showMessage('命令执行完成', 'success');
                            return;
                        } else if (status.Failed) {
                            // 命令执行失败
                            document.getElementById('command-result').textContent = 
                                `命令执行失败: ${status.Failed}`;
                            
                            // 恢复按钮状态
                            const btn = document.getElementById('execute-btn');
                            btn.disabled = false;
                            btn.textContent = '执行命令';
                            
                            showMessage('命令执行失败', 'error');
                            return;
                        } else if (status.Timeout) {
                            // 命令超时
                            document.getElementById('command-result').textContent = '命令执行超时';
                            
                            // 恢复按钮状态
                            const btn = document.getElementById('execute-btn');
                            btn.disabled = false;
                            btn.textContent = '执行命令';
                            
                            showMessage('命令执行超时', 'error');
                            return;
                        }
                        
                        // 继续轮询
                        if (attempts < maxAttempts) {
                            document.getElementById('command-result').textContent = 
                                `正在等待执行结果... (${attempts}/${maxAttempts})`;
                            setTimeout(poll, pollInterval);
                        } else {
                            // 超过最大尝试次数
                            document.getElementById('command-result').textContent = 
                                '等待执行结果超时，请检查客户端连接状态';
                            
                            // 恢复按钮状态
                            const btn = document.getElementById('execute-btn');
                            btn.disabled = false;
                            btn.textContent = '执行命令';
                            
                            showMessage('等待执行结果超时', 'error');
                        }
                        
                    } else {
                        throw new Error(`Failed to get command status: ${response.status}`);
                    }
                    
                } catch (error) {
                    console.error('Error polling command result:', error);
                    
                    // 继续尝试，但如果是网络错误就提前结束
                    if (attempts < maxAttempts && !error.message.includes('fetch')) {
                        setTimeout(poll, pollInterval);
                    } else {
                        document.getElementById('command-result').textContent = 
                            `获取命令结果时发生错误: ${error.message}`;
                        
                        // 恢复按钮状态
                        const btn = document.getElementById('execute-btn');
                        btn.disabled = false;
                        btn.textContent = '执行命令';
                        
                        showMessage('获取命令结果失败', 'error');
                    }
                }
            };
            
            // 开始轮询
            setTimeout(poll, pollInterval);
        }
        
        // 显示命令执行结果
        function displayCommandResult(result) {
            const resultElement = document.getElementById('command-result');
            
            let displayText = `命令: ${result.command}\n`;
            displayText += `执行时间: ${formatTime(result.executed_at)}\n`;
            displayText += `退出码: ${result.exit_code}\n`;
            displayText += `\n--- 标准输出 ---\n${result.output || '(无输出)'}`;
            
            if (result.error_output && result.error_output.trim()) {
                displayText += `\n\n--- 错误输出 ---\n${result.error_output}`;
            }
            
            resultElement.textContent = displayText;
        }
        
        // 处理回车键执行命令
        function handleCommandKeyPress(event) {
            if (event.key === 'Enter') {
                executeCommand();
            }
        }
        
        // 显示命令结果区域
        function showCommandResult() {
            document.getElementById('command-result-section').style.display = 'block';
        }
        
        // 清空结果
        function clearResult() {
            document.getElementById('command-result').textContent = '';
            document.getElementById('command-result-section').style.display = 'none';
        }
        
        // 添加到命令历史
        function addToHistory(clientId, command) {
            const historyContainer = document.getElementById('command-history');
            
            // 如果是第一个命令，清空默认文本
            if (historyContainer.textContent.includes('暂无历史记录')) {
                historyContainer.innerHTML = '';
            }
            
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <div><strong>[${new Date().toLocaleTimeString()}]</strong> ${command}</div>
                <div>目标: ${clientId.substring(0, 8)}... <button onclick="repeatCommand('${clientId}', '${command}')" style="font-size: 10px; padding: 2px 5px;">重复执行</button></div>
            `;
            
            historyContainer.insertBefore(historyItem, historyContainer.firstChild);
            
            // 限制历史记录数量
            while (historyContainer.children.length > 10) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
        }
        
        // 重复执行命令
        function repeatCommand(clientId, command) {
            document.getElementById('client-select').value = clientId;
            document.getElementById('command-input').value = command;
            executeCommand();
        }
        
        // 发送广播消息
        async function sendBroadcast() {
            const message = document.getElementById('broadcast-message').value.trim();
            if (!message) {
                showMessage('请输入广播消息内容', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/send-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                if (response.ok) {
                    showMessage('广播消息发送成功', 'success');
                    document.getElementById('broadcast-message').value = '';
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                showMessage('广播消息发送失败: ' + error.message, 'error');
            }
        }
        
        // 显示消息提示
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type}`;
            messageDiv.textContent = message;
            
            // 添加点击事件，点击可关闭
            messageDiv.addEventListener('click', function() {
                closeMessage(messageDiv);
            });
            
            messageArea.appendChild(messageDiv);
            
            // 8秒后自动删除消息 (比原来长一点，给用户更多时间阅读)
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    closeMessage(messageDiv);
                }
            }, 8000);
        }
        
        // 关闭消息的函数，带有滑出动画
        function closeMessage(messageDiv) {
            if (!messageDiv.parentNode) return;
            
            messageDiv.classList.add('slide-out');
            
            // 等待动画完成后删除元素
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 300); // 与CSS动画时长匹配
        }
        
        // 格式化字节数
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 格式化时间
        function formatTime(timestamp) {
            if (!timestamp) return '未知';
            
            // 处理 {secs_since_epoch, nanos_since_epoch} 格式
            if (typeof timestamp === 'object' && timestamp.secs_since_epoch) {
                const date = new Date(timestamp.secs_since_epoch * 1000);
                return date.toLocaleString('zh-CN');
            }
            
            // 处理其他格式
            const date = new Date(timestamp);
            if (isNaN(date.getTime())) {
                return '无效时间';
            }
            return date.toLocaleString('zh-CN');
        }
        
        // 计算客户端状态和最后心跳时间差
        function getClientStatus(lastSeen) {
            if (!lastSeen) return { status: 'offline', timeAgo: '未知' };
            
            let lastSeenTime;
            if (typeof lastSeen === 'object' && lastSeen.secs_since_epoch) {
                lastSeenTime = new Date(lastSeen.secs_since_epoch * 1000);
            } else {
                lastSeenTime = new Date(lastSeen);
            }
            
            const now = new Date();
            const diffSeconds = Math.floor((now - lastSeenTime) / 1000);
            
            let timeAgo;
            if (diffSeconds < 60) {
                timeAgo = diffSeconds + '秒前';
            } else if (diffSeconds < 3600) {
                timeAgo = Math.floor(diffSeconds / 60) + '分钟前';
            } else {
                timeAgo = Math.floor(diffSeconds / 3600) + '小时前';
            }
            
            // 30秒内认为在线，超过30秒认为离线
            const status = diffSeconds <= 30 ? 'online' : 'offline';
            
            return { status, timeAgo, diffSeconds };
        }
        
        // 切换命令类型（预定义 vs 自定义）
        function toggleCommandType() {
            const predefinedRadio = document.getElementById('predefined-cmd');
            const predefinedSection = document.getElementById('predefined-commands-section');
            const customSection = document.getElementById('custom-command-section');
            
            if (predefinedRadio.checked) {
                predefinedSection.style.display = 'block';
                customSection.style.display = 'none';
            } else {
                predefinedSection.style.display = 'none';
                customSection.style.display = 'block';
            }
        }
        
        // 获取预定义命令列表
        async function fetchPredefinedCommands() {
            try {
                const response = await fetch('/api/predefined-commands');
                if (response.ok) {
                    allPredefinedCommands = await response.json();
                    predefinedCommands = [...allPredefinedCommands];
                    updatePredefinedCommandsUI();
                } else {
                    // 如果服务端没有提供API，使用本地默认命令
                    allPredefinedCommands = getDefaultPredefinedCommands();
                    predefinedCommands = [...allPredefinedCommands];
                    updatePredefinedCommandsUI();
                }
            } catch (error) {
                // 使用本地默认命令作为备选
                allPredefinedCommands = getDefaultPredefinedCommands();
                predefinedCommands = [...allPredefinedCommands];
                updatePredefinedCommandsUI();
            }
        }
        
        // 获取默认的预定义命令（如果服务端API不可用）
        function getDefaultPredefinedCommands() {
            return [
                { command: "ps aux", name: "查看所有进程", category: "系统信息", description: "显示所有运行中的进程详细信息" },
                { command: "whoami", name: "查看当前用户", category: "系统信息", description: "显示当前登录的用户名" },
                { command: "free -h", name: "查看内存使用", category: "资源监控", description: "以人类可读格式显示内存使用情况" },
                { command: "df -h", name: "查看磁盘空间", category: "资源监控", description: "以人类可读格式显示磁盘使用情况" },
                { command: "top -n 1", name: "查看进程资源使用", category: "资源监控", description: "显示当前进程CPU和内存使用情况" },
                { command: "netstat -tlnp", name: "查看监听端口", category: "网络信息", description: "显示所有TCP监听端口" },
                { command: "ls -la", name: "查看目录内容", category: "文件系统", description: "详细显示当前目录下的文件和文件夹" },
                { command: "systemctl status", name: "查看服务状态", category: "服务管理", description: "显示系统服务的总体状态" },
                { command: "date", name: "查看系统时间", category: "系统信息", description: "显示当前系统日期和时间" },
                { command: "uptime", name: "查看系统运行时间", category: "系统信息", description: "显示系统运行时间和负载" }
            ];
        }
        
        // 更新预定义命令UI
        function updatePredefinedCommandsUI() {
            // 更新命令选择下拉框
            const select = document.getElementById('predefined-select');
            select.innerHTML = '<option value="">-- 选择预定义命令 --</option>';
            
            predefinedCommands.forEach((cmd, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `[${cmd.category}] ${cmd.name}`;
                select.appendChild(option);
            });
            
            // 更新类别筛选下拉框
            const categories = [...new Set(allPredefinedCommands.map(cmd => cmd.category))];
            const categorySelect = document.getElementById('category-filter');
            categorySelect.innerHTML = '<option value="">所有类别</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }
        
        // 按类别筛选命令
        function filterCommandsByCategory() {
            const selectedCategory = document.getElementById('category-filter').value;
            
            if (selectedCategory) {
                predefinedCommands = allPredefinedCommands.filter(cmd => cmd.category === selectedCategory);
            } else {
                predefinedCommands = [...allPredefinedCommands];
            }
            
            updatePredefinedCommandsUI();
        }
        
        // 更新命令描述
        function updateCommandDescription() {
            const select = document.getElementById('predefined-select');
            const descriptionDiv = document.getElementById('command-description');
            
            if (select.value === '') {
                descriptionDiv.style.display = 'none';
                return;
            }
            
            const selectedIndex = parseInt(select.value);
            const selectedCommand = predefinedCommands[selectedIndex];
            
            if (selectedCommand) {
                descriptionDiv.innerHTML = `
                    <strong>命令:</strong> <code>${selectedCommand.command}</code><br>
                    <strong>描述:</strong> ${selectedCommand.description}
                `;
                descriptionDiv.style.display = 'block';
            } else {
                descriptionDiv.style.display = 'none';
            }
        }
        
        // 修改executeCommand函数以支持预定义命令
        function getSelectedCommand() {
            const predefinedRadio = document.getElementById('predefined-cmd');
            
            if (predefinedRadio.checked) {
                // 使用预定义命令
                const select = document.getElementById('predefined-select');
                if (select.value === '') {
                    throw new Error('请选择一个预定义命令');
                }
                
                const selectedIndex = parseInt(select.value);
                const selectedCommand = predefinedCommands[selectedIndex];
                return selectedCommand.command;
            } else {
                // 使用自定义命令
                const commandInput = document.getElementById('command-input');
                const command = commandInput.value.trim();
                if (!command) {
                    throw new Error('请输入命令');
                }
                return command;
            }
        }
        
        // 获取所有客户端的应用信息
        async function fetchAppsInfo() {
            try {
                // 同时获取应用信息和客户端信息
                const [appsResponse, clientsResponse] = await Promise.all([
                    fetch('/api/apps'),
                    fetch('/api/clients')
                ]);
                
                const appsData = await appsResponse.json();
                const clientsData = await clientsResponse.json();
                
                displayAppsInfo(appsData.client_apps, clientsData.clients);
                
                // 更新最后更新时间
                document.getElementById('apps-last-update').textContent = 
                    `最后更新: ${new Date().toLocaleString('zh-CN')}`;
            } catch (error) {
                console.error('获取应用信息失败:', error);
                showMessage('获取应用信息失败: ' + error.message, 'error');
                document.getElementById('apps-container').innerHTML = 
                    '<p style="color: red;">获取应用信息失败</p>';
            }
        }

        // 显示应用信息
        function displayAppsInfo(clientApps, clients) {
            const container = document.getElementById('apps-container');
            
            if (!clientApps || Object.keys(clientApps).length === 0) {
                container.innerHTML = '<div class="no-apps">暂无客户端应用信息</div>';
                return;
            }

            const html = Object.values(clientApps).map(clientAppInfo => {
                const { client_id, hostname, apps } = clientAppInfo;
                
                // 获取客户端信息来判断状态
                const clientData = clients ? Object.values(clients).find(client => 
                    client.system_info && client.system_info.hostname === hostname) : null;
                
                let statusClass = 'status-online';
                let statusText = '在线';
                let clientStyle = '';
                
                if (clientData) {
                    const clientStatus = getClientStatus(clientData.last_seen);
                    statusClass = clientStatus.status === 'online' ? 'status-online' : 'status-offline';
                    statusText = clientStatus.status === 'online' ? '在线' : '离线';
                    if (clientStatus.status === 'offline') {
                        clientStyle = 'opacity: 0.6; border: 2px solid #e74c3c;';
                    }
                }
                
                let appsHtml = '';
                if (apps && apps.length > 0) {
                    appsHtml = apps.map(app => `
                        <div class="app-item">
                            <div class="app-name">${app.name}</div>
                            <div class="app-details">
                                <div><strong>版本:</strong> <span class="app-version">${app.version}</span></div>
                                <div><strong>部署时间:</strong> ${app.deploy_time}</div>
                                ${app.branch ? `<div><strong>分支:</strong> ${app.branch}</div>` : ''}
                                ${app.commit ? `<div><strong>提交:</strong> <code>${app.commit}</code></div>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    appsHtml = '<div class="no-apps">该客户端暂无应用部署</div>';
                }

                return `
                    <div class="client-apps" style="${clientStyle}">
                        <h3>
                            <span class="status-indicator ${statusClass}"></span>
                            ${hostname}
                            <small style="color: ${statusText === '在线' ? '#27ae60' : '#e74c3c'}; font-weight: normal;">
                                (${client_id.substring(0, 8)}...) - ${statusText}
                            </small>
                        </h3>
                        ${appsHtml}
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="app-grid">${html}</div>`;
        }

        // 手动刷新应用信息
        function refreshAppsInfo() {
            document.getElementById('apps-container').innerHTML = '<p>正在刷新应用信息...</p>';
            fetchAppsInfo();
        }
        
        // 标签页切换功能
        function showTab(tabId) {
            // 隐藏所有标签内容
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });

            // 移除所有按钮的active类
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            // 显示选中的标签内容
            document.getElementById(tabId).classList.add('active');

            // 添加选中按钮的active类
            event.target.classList.add('active');

            // 如果切换到应用管理标签，刷新数据
            if (tabId === 'app-management-tab') {
                refreshAppsManagement();
            }
        }

        // 应用管理相关变量
        let currentUpdateContext = {};
        let originalAppsData = null; // 存储原始应用数据用于过滤
        let originalClientsData = null; // 存储原始客户端数据用于过滤

        // 刷新应用管理数据
        async function refreshAppsManagement() {
            const container = document.getElementById('app-management-container');
            container.innerHTML = '<p>正在加载应用管理数据...</p>';

            try {
                const [appsResponse, clientsResponse] = await Promise.all([
                    fetch('/api/apps'),
                    fetch('/api/clients')
                ]);
                
                const appsData = await appsResponse.json();
                const clientsData = await clientsResponse.json();
                
                // 存储原始数据用于过滤
                originalAppsData = appsData.client_apps;
                originalClientsData = clientsData.clients;
                
                // 更新过滤器选项
                updateFilterOptions(originalAppsData, originalClientsData);
                
                displayAppsManagement(originalAppsData, originalClientsData);
                
                document.getElementById('app-management-last-update').textContent = 
                    `最后更新: ${new Date().toLocaleString('zh-CN')}`;
            } catch (error) {
                console.error('获取应用管理数据失败:', error);
                showMessage('获取应用管理数据失败: ' + error.message, 'error');
                container.innerHTML = '<p style="color: red;">获取应用管理数据失败</p>';
            }
        }

        // 显示应用管理表格
        function displayAppsManagement(clientApps, clients) {
            const container = document.getElementById('app-management-container');
            
            if (!clientApps || Object.keys(clientApps).length === 0) {
                container.innerHTML = '<div class="no-apps">暂无应用数据</div>';
                return;
            }

            let tableRows = '';
            
            Object.values(clientApps).forEach(clientAppInfo => {
                const { client_id, hostname, apps } = clientAppInfo;
                
                // 获取客户端状态
                const clientData = clients ? Object.values(clients).find(client => 
                    client.system_info && client.system_info.hostname === hostname) : null;
                
                let clientStatusClass = 'status-online';
                let clientStatusText = '在线';
                
                if (clientData) {
                    const clientStatus = getClientStatus(clientData.last_seen);
                    clientStatusClass = clientStatus.status === 'online' ? 'status-online' : 'status-offline';
                    clientStatusText = clientStatus.status === 'online' ? '在线' : '离线';
                }

                if (apps && apps.length > 0) {
                    apps.forEach(app => {
                        const serviceStatus = getServiceStatusDisplay(app.service_status);
                        const serviceAction = getServiceAction(app.service_status);
                        
                        tableRows += `
                            <tr>
                                <td>
                                    <span class="status-indicator ${clientStatusClass}"></span>
                                    ${hostname}
                                    <small style="color: ${clientStatusText === '在线' ? '#27ae60' : '#e74c3c'};">
                                        (${client_id.substring(0, 8)}...) - ${clientStatusText}
                                    </small>
                                </td>
                                <td>${app.name}</td>
                                <td><span class="app-version">${app.version}</span></td>
                                <td>${app.deploy_time}</td>
                                <td>
                                    <span class="service-status ${serviceStatus.class}">${serviceStatus.text}</span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn btn-update" onclick="showUpdateModal('${client_id}', '${hostname}', '${app.name}', '${app.version}')">更新</button>
                                        <button class="action-btn ${serviceAction.class}" onclick="manageService('${client_id}', '${app.name}', '${serviceAction.action}')">${serviceAction.text}</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    tableRows += `
                        <tr>
                            <td>
                                <span class="status-indicator ${clientStatusClass}"></span>
                                ${hostname}
                                <small style="color: ${clientStatusText === '在线' ? '#27ae60' : '#e74c3c'};">
                                    (${client_id.substring(0, 8)}...) - ${clientStatusText}
                                </small>
                            </td>
                            <td colspan="5" style="color: #999; font-style: italic;">该客户端暂无应用部署</td>
                        </tr>
                    `;
                }
            });

            const table = `
                <table class="app-management-table">
                    <thead>
                        <tr>
                            <th>客户端</th>
                            <th>应用名称</th>
                            <th>版本</th>
                            <th>部署时间</th>
                            <th>服务状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;

            container.innerHTML = table;
        }

        // 获取服务状态显示信息
        function getServiceStatusDisplay(serviceStatus) {
            if (typeof serviceStatus === 'string') {
                // 处理字符串格式的状态
                switch (serviceStatus.toLowerCase()) {
                    case 'running':
                        return { class: 'status-running', text: '运行中' };
                    case 'stopped':
                        return { class: 'status-stopped', text: '已停止' };
                    default:
                        return { class: 'status-unknown', text: '未知' };
                }
            } else if (typeof serviceStatus === 'object') {
                // 处理对象格式的状态
                if (serviceStatus.Running) {
                    return { class: 'status-running', text: `运行中 (PID: ${serviceStatus.Running})` };
                } else if (serviceStatus.Stopped) {
                    return { class: 'status-stopped', text: '已停止' };
                } else if (serviceStatus.Unknown) {
                    return { class: 'status-unknown', text: '未知' };
                }
            }
            return { class: 'status-unknown', text: '未知' };
        }

        // 获取服务操作信息
        function getServiceAction(serviceStatus) {
            const isRunning = (typeof serviceStatus === 'string' && serviceStatus.toLowerCase() === 'running') ||
                             (typeof serviceStatus === 'object' && serviceStatus.Running);
            
            return isRunning 
                ? { class: 'btn-stop', text: '停止服务', action: 'Stop' }
                : { class: 'btn-start', text: '启动服务', action: 'Start' };
        }

        // 显示更新模态框
        function showUpdateModal(clientId, hostname, appName, currentVersion) {
            currentUpdateContext = { clientId, hostname, appName, currentVersion };
            
            document.getElementById('update-client-info').textContent = `${hostname} (${clientId.substring(0, 8)}...)`;
            document.getElementById('update-app-info').textContent = `${appName} (当前版本: ${currentVersion})`;
            document.getElementById('update-version').value = '';
            
            document.getElementById('update-modal').style.display = 'block';
        }

        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // 确认更新
        async function confirmUpdate() {
            const newVersion = document.getElementById('update-version').value.trim();
            if (!newVersion) {
                showMessage('请输入新版本号', 'error');
                return;
            }

            const { clientId, appName } = currentUpdateContext;
            
            try {
                const response = await fetch('/api/update-app', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: clientId,
                        app_name: appName,
                        version: newVersion
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage(`更新命令已发送: ${result.message}`, 'success');
                    closeModal('update-modal');
                    
                    // 可以选择性地轮询命令结果
                    if (result.command_id) {
                        pollCommandResult(result.command_id);
                    }
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
            } catch (error) {
                showMessage('更新失败: ' + error.message, 'error');
            }
        }

        // 管理服务（启动/停止）
        async function manageService(clientId, appName, action) {
            const actionText = action === 'Start' ? '启动' : '停止';
            
            if (!confirm(`确定要${actionText}服务 "${appName}" 吗？`)) {
                return;
            }

            try {
                const response = await fetch('/api/manage-service', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: clientId,
                        app_name: appName,
                        action: action
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage(`${actionText}服务命令已发送: ${result.message}`, 'success');
                    
                    // 可以选择性地轮询命令结果
                    if (result.command_id) {
                        pollCommandResult(result.command_id);
                    }

                    // 延迟刷新应用管理数据以显示新状态
                    setTimeout(() => {
                        refreshAppsManagement();
                    }, 2000);
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
            } catch (error) {
                showMessage(`${actionText}服务失败: ` + error.message, 'error');
            }
        }

        // 过滤功能相关函数
        
        // 更新过滤器选项
        function updateFilterOptions(clientApps, clients) {
            const clientFilter = document.getElementById('filter-client');
            const currentClientValue = clientFilter.value;
            
            // 保留第一个默认选项
            clientFilter.innerHTML = '<option value="">全部客户端</option>';
            
            if (clientApps) {
                Object.values(clientApps).forEach(clientAppInfo => {
                    const option = document.createElement('option');
                    option.value = clientAppInfo.client_id;
                    option.textContent = `${clientAppInfo.hostname} (${clientAppInfo.client_id.substring(0, 8)}...)`;
                    clientFilter.appendChild(option);
                });
                
                // 恢复之前选中的值
                if (currentClientValue) {
                    clientFilter.value = currentClientValue;
                }
            }
        }
        
        // 应用过滤器
        function applyFilters() {
            if (!originalAppsData || !originalClientsData) {
                return;
            }
            
            const clientFilter = document.getElementById('filter-client').value.toLowerCase();
            const appNameFilter = document.getElementById('filter-app-name').value.toLowerCase().trim();
            const statusFilter = document.getElementById('filter-status').value;
            const serviceStatusFilter = document.getElementById('filter-service-status').value;
            
            let filteredAppsData = {};
            let totalApps = 0;
            let filteredApps = 0;
            
            Object.values(originalAppsData).forEach(clientAppInfo => {
                const { client_id, hostname, apps } = clientAppInfo;
                
                // 获取客户端状态
                const clientData = originalClientsData ? Object.values(originalClientsData).find(client => 
                    client.system_info && client.system_info.hostname === hostname) : null;
                
                let clientStatus = 'offline';
                if (clientData) {
                    const status = getClientStatus(clientData.last_seen);
                    clientStatus = status.status;
                }
                
                // 过滤客户端
                if (clientFilter && client_id.toLowerCase() !== clientFilter) {
                    return;
                }
                
                // 过滤客户端状态
                if (statusFilter && clientStatus !== statusFilter) {
                    return;
                }
                
                let filteredClientApps = [];
                
                if (apps && apps.length > 0) {
                    totalApps += apps.length;
                    
                    apps.forEach(app => {
                        // 过滤应用名称
                        if (appNameFilter && !app.name.toLowerCase().includes(appNameFilter)) {
                            return;
                        }
                        
                        // 过滤服务状态
                        if (serviceStatusFilter) {
                            const appServiceStatus = getServiceStatusType(app.service_status);
                            if (appServiceStatus !== serviceStatusFilter) {
                                return;
                            }
                        }
                        
                        filteredClientApps.push(app);
                        filteredApps++;
                    });
                }
                
                // 如果应用名称过滤器有值但该客户端没有匹配的应用，则不显示该客户端
                if (appNameFilter && filteredClientApps.length === 0 && apps && apps.length > 0) {
                    return;
                }
                
                // 添加到过滤结果
                filteredAppsData[client_id] = {
                    client_id,
                    hostname,
                    apps: filteredClientApps
                };
            });
            
            // 显示过滤结果
            displayAppsManagement(filteredAppsData, originalClientsData);
            
            // 更新过滤结果信息
            updateFilterResultsInfo(filteredApps, totalApps);
        }
        
        // 获取服务状态类型（用于过滤）
        function getServiceStatusType(serviceStatus) {
            if (typeof serviceStatus === 'string') {
                return serviceStatus.toLowerCase();
            } else if (typeof serviceStatus === 'object') {
                if (serviceStatus.Running) {
                    return 'running';
                } else if (serviceStatus.Stopped) {
                    return 'stopped';
                } else if (serviceStatus.Unknown) {
                    return 'unknown';
                }
            }
            return 'unknown';
        }
        
        // 更新过滤结果信息
        function updateFilterResultsInfo(filteredCount, totalCount) {
            const infoElement = document.getElementById('filter-results-info');
            if (filteredCount !== totalCount) {
                infoElement.textContent = `显示 ${filteredCount} / ${totalCount} 个应用`;
                infoElement.style.color = '#007bff';
                infoElement.style.fontWeight = 'bold';
            } else {
                infoElement.textContent = `显示全部 ${totalCount} 个应用`;
                infoElement.style.color = '#666';
                infoElement.style.fontWeight = 'normal';
            }
        }
        
        // 清空过滤器
        function clearFilters() {
            document.getElementById('filter-client').value = '';
            document.getElementById('filter-app-name').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-service-status').value = '';
            
            // 重新显示原始数据
            if (originalAppsData && originalClientsData) {
                displayAppsManagement(originalAppsData, originalClientsData);
                
                // 更新结果信息
                let totalApps = 0;
                Object.values(originalAppsData).forEach(clientAppInfo => {
                    if (clientAppInfo.apps && clientAppInfo.apps.length > 0) {
                        totalApps += clientAppInfo.apps.length;
                    }
                });
                updateFilterResultsInfo(totalApps, totalApps);
            }
        }

        // 活动监控相关功能
        function startActivityMonitoring() {
            // 记录活动时间
            updateLastActivity();
            
            // 监听用户活动事件
            const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            activityEvents.forEach(event => {
                document.addEventListener(event, updateLastActivity, { passive: true });
            });
            
            // 定期检查会话状态
            activityCheckInterval = setInterval(checkSessionStatus, ACTIVITY_CHECK_INTERVAL);
            
            // 设置会话超时定时器
            resetSessionTimeout();
        }
        
        function stopActivityMonitoring() {
            // 清除定时器
            if (sessionTimeoutId) {
                clearTimeout(sessionTimeoutId);
                sessionTimeoutId = null;
            }
            if (activityCheckInterval) {
                clearInterval(activityCheckInterval);
                activityCheckInterval = null;
            }
            
            // 移除事件监听器
            const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            activityEvents.forEach(event => {
                document.removeEventListener(event, updateLastActivity, { passive: true });
            });
        }
        
        function updateLastActivity() {
            lastActivity = new Date();
            // 重置会话超时定时器
            resetSessionTimeout();
        }
        
        function resetSessionTimeout() {
            if (sessionTimeoutId) {
                clearTimeout(sessionTimeoutId);
            }
            
            sessionTimeoutId = setTimeout(() => {
                handleAutoLogout('会话已过期，请重新登录');
            }, SESSION_TIMEOUT);
        }
        
        function checkSessionStatus() {
            if (!isAuthenticated || !lastActivity) {
                return;
            }
            
            const now = new Date();
            const timeSinceLastActivity = now - lastActivity;
            const timeUntilLogout = SESSION_TIMEOUT - timeSinceLastActivity;
            
            // 如果距离自动登出还有WARNING_TIME时间，显示警告
            if (timeUntilLogout <= WARNING_TIME && timeUntilLogout > 0) {
                const minutesLeft = Math.ceil(timeUntilLogout / (60 * 1000));
                showMessage(`您的会话将在 ${minutesLeft} 分钟后过期，请进行任意操作以延长会话`, 'info');
            }
            
            // 定期检查服务器端的认证状态
            if (timeSinceLastActivity < 30 * 60 * 1000) { // 仅30分钟内有活动才检查服务器认证
                checkAuthStatus();
            }
        }
        
        function handleAutoLogout(reason) {
            setUnauthenticatedState();
            showMessage(reason, 'error');
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function() {
            // 首先检查认证状态
            const isAuth = await checkAuthStatus();
            if (!isAuth) {
                setUnauthenticatedState();
            }
        });
    </script>
</body>
</html>
